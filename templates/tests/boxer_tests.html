{% extends "base.html" %}
{% block content %}
<h2 class="page-title">üìä {{ boxer.first_name }} {{ boxer.last_name }} ‚Äî Test Results</h2>

<!-- Test selector -->
<form method="get" action="{% url 'boxer_tests' boxer.uuid %}" class="filter-bar">
  <label class="filter-label">Choose Test</label>
  <select name="test" onchange="this.form.submit()">
    {% for t in tests %}
      <option value="{{ t.id }}" {% if selected_test and t.id == selected_test.id %}selected{% endif %}>
        {{ t.name }}{% if t.unit %} [{{ t.unit }}]{% endif %}
      </option>
    {% endfor %}
  </select>
  <noscript><button class="btn btn--primary" type="submit">Apply</button></noscript>
</form>

{% if selected_test %}
  <h3 class="section-title">‚ö° Progress for {{ selected_test.name }} {% if unit %}({{ unit }}){% endif %}</h3>

  <!-- Summary -->
  <div class="summary-card">
    <h4>üìå Summary</h4>
    {% if summary %}
      <ul>
        {% for row in summary %}
          <li>
            {% if row.avg %}
              <strong>{{ row.avg|floatformat:2 }}</strong>{% if unit %} {{ unit }}{% endif %}
            {% endif %}
            <span class="muted"> ‚Äî {{ row.date|date:"Y-m-d" }}</span>
            {% if row.notes %}
              <br><span class="notes">üìù {{ row.notes|join:", " }}</span>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="muted"><em>No results yet.</em></p>
    {% endif %}
  </div>

  <!-- Chart -->
  {{ labels|json_script:"labels-data" }}
  {{ values|json_script:"values-data" }}
  <div class="chart-box">
    <canvas id="progressChart"></canvas>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    (function(){
      const labels = JSON.parse(document.getElementById('labels-data').textContent || "[]");
      const values = JSON.parse(document.getElementById('values-data').textContent || "[]");

      const ctx = document.getElementById('progressChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: '{{ selected_test.name|escapejs }}{% if unit %} ({{ unit|escapejs }}){% endif %}',
            data: values,
            tension: 0.35,
            pointRadius: 4,
            borderWidth: 2,
            borderColor: '#00ff66',
            backgroundColor: '#00ff66',
            fill: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { title: { display: true, text: 'Date' } },
            y: { title: { display: true, text: '{{ unit|default:"Value"|escapejs }}' }, beginAtZero: false }
          },
          plugins: {
            legend: { display: true, labels: { color: '#eee' } }
          }
        }
      });
    })();
  </script>
{% endif %}

<style>
/* Filter bar */
.filter-bar {
  display: flex;
  flex-wrap: wrap;
  gap: .6rem;
  align-items: center;
  margin-bottom: 1rem;
}
.filter-label { font-weight:700; color:var(--brand); }
.filter-bar select {
  padding: 8px 12px;
  border: 1px solid var(--border);
  border-radius: 10px;
  background: #0f0f0f;
  color: var(--text);
  font-weight: 600;
}

/* Section titles */
.section-title { margin-top:1.5rem; font-size:1.2rem; font-weight:700; }

/* Summary block */
.summary-card {
  background: linear-gradient(145deg,#0e0e0e,#181818);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 16px;
  margin: 1rem 0;
  box-shadow:
    0 -2px 6px rgba(0,255,102,.4),
    0  2px 6px rgba(0,255,102,.4),
    0  0 12px rgba(0,255,102,.2);
}
.summary-card h4 { margin:0 0 .5rem; color:var(--brand); }
.summary-card ul { margin:0; padding-left:18px; display:grid; gap:.5rem; }
.summary-card li { font-size:15px; }
.summary-card .muted { font-size:13px; color:var(--muted); }
.summary-card .notes { font-size:13px; color:#ffaa00; }

/* Chart container */
.chart-box {
  position: relative;
  height: 360px;
  max-width: 100%;
  margin-top: 1rem;
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px;
  background:#111;
  box-shadow:
    0 -2px 6px rgba(0,255,102,.3),
    0  2px 6px rgba(0,255,102,.3);
}

/* Mobile fixes */
*, *::before, *::after { box-sizing:border-box; }
html, body { max-width:100%; overflow-x:hidden; }
</style>
{% endblock %}
