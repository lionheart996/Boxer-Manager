{#    {% extends "base.html" %}#}
{#    {% block content %}#}
{#    <h2 class="page-title" style="margin-left:75px;">Battery Test Results</h2>#}
{##}
{#    <style>#}
{#      /* Page-scoped tweaks to make the table narrower */#}
{#      .tests-table th, .tests-table td { padding: 4px; }#}
{#      .tests-table th { white-space: nowrap; }#}
{#      .cell { min-width: 120px; }#}
{#      .vgrid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; }#}
{#      .test-input { width: 54px; padding: 2px; font-size: 12px; }#}
{#      .test-notes { width: 100%; padding: 2px; font-size: 12px; }#}
{#      .cell .btn { margin: 4px 0 0 0; padding: 6px 8px; }#}
{#      .subtle { font-size: 11px; color: #7bdc9f; }#}
{#      .toolbar { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:10px; }#}
{#    </style>#}
{##}
{#    <div class="content-container">#}
{##}
{#      <!-- Top toolbar: navigation + phase switcher (GET) -->#}
{#      <div class="toolbar">#}
{#        <a class="btn" href="{% url 'tests_list' %}">Manage Tests</a>#}
{#        <a class="btn" href="{% url 'tests_summary' %}">Tests Summary</a>#}
{#        <a class="btn" href="{% url 'tests_manage_boxers' %}">Manage Boxers</a>#}
{##}
{#        <form method="get" action="{% url 'tests_results' %}" style="display:flex; gap:8px; align-items:center;">#}
{#          {% if phase_form %}{{ phase_form.phase }}{% else %}#}
{#            <select name="phase">#}
{#              <option value="pre" {% if phase == 'pre' %}selected{% endif %}>Pre season</option>#}
{#              <option value="mid" {% if phase == 'mid' %}selected{% endif %}>Mid season</option>#}
{#              <option value="before" {% if phase == 'before' %}selected{% endif %}>Before Tournament</option>#}
{#            </select>#}
{#          {% endif %}#}
{#          <button class="btn" type="submit">Switch Phase</button>#}
{#        </form>#}
{#      </div>#}
{##}
{#      {% if not tests %}#}
{#        <p>No tests yet. <a class="btn" href="{% url 'tests_list' %}">Create one</a>.</p>#}
{#      {% elif not boxers %}#}
{#        <p>No boxers found.</p>#}
{#      {% else %}#}
{##}
{#      <!-- One global form powers both Save All and per-cell Save -->#}
{#      <form id="matrix" method="post" action="{% url 'tests_results' %}?phase={{ phase }}">#}
{#        {% csrf_token %}#}
{#        <input type="hidden" name="phase" value="{{ phase }}">#}
{##}
{#        <div style="overflow-x:auto;">#}
{#          <table class="tests-table">#}
{#            <thead>#}
{#              <tr>#}
{#                <th>Boxer \\ Test</th>#}
{#                {% for t in tests %}#}
{#                  <th>#}
{#                    {{ t.name }}{% if t.unit %} [{{ t.unit }}]{% endif %}<br>#}
{#                    <span class="subtle">v1 / v2 / v3</span>#}
{#                  </th>#}
{#                {% endfor %}#}
{#              </tr>#}
{#            </thead>#}
{##}
{#            <tbody>#}
{#              {% for b in boxers %}#}
{#                <tr>#}
{#                  <td><a href="{% url 'boxer_tests' b.id %}">{{ b.name }}</a></td>#}
{##}
{#                  {% for t in tests %}#}
{#                    <td class="cell">#}
{#                      <!-- 3 compact inputs per boxer×test -->#}
{#                      <div class="vgrid">#}
{#                        <input class="test-input" name="r-{{ b.id }}-{{ t.id }}-value1" type="number" step="0.01" placeholder="v1" inputmode="decimal">#}
{#                        <input class="test-input" name="r-{{ b.id }}-{{ t.id }}-value2" type="number" step="0.01" placeholder="v2" inputmode="decimal">#}
{#                        <input class="test-input" name="r-{{ b.id }}-{{ t.id }}-value3" type="number" step="0.01" placeholder="v3" inputmode="decimal">#}
{#                      </div>#}
{#                      <input class="test-notes" name="r-{{ b.id }}-{{ t.id }}-notes" type="text" placeholder="notes">#}
{##}
{#                      <!-- Hidden IDs for per-cell save -->#}
{#                      <input type="hidden" name="boxer_id" value="{{ b.id }}">#}
{#                      <input type="hidden" name="test_id"  value="{{ t.id }}">#}
{##}
{#                      <!-- Per-cell Save (reuses the global form), keep phase in URL -->#}
{#                      <button#}
{#                        class="btn"#}
{#                        type="submit"#}
{#                        form="matrix"#}
{#                        formaction="{% url 'tests_result_save' %}?b={{ b.id }}&t={{ t.id }}&phase={{ phase }}"#}
{#                      >#}
{#                        Save#}
{#                      </button>#}
{#                    </td>#}
{#                  {% endfor %}#}
{#                </tr>#}
{#              {% endfor %}#}
{#            </tbody>#}
{#          </table>#}
{#        </div>#}
{##}
{#        <p><button class="btn" type="submit">Save All</button></p>#}
{#      </form>#}
{#      {% endif %}#}
{#    </div>#}
{#    {% endblock %}#}


{% extends "base.html" %}
{% block content %}
<h2 class="page-title" style="margin-left:75px;">Battery Test Results</h2>

<style>
  .inline-form { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .picker { min-width:220px; }
  .hidden { display:none; }
  .result-table { border-collapse: collapse; margin-top:14px; width:100%; max-width:720px; }
  .result-table th, .result-table td { border:1px solid #ddd; padding:8px; }
  .result-table th { background:#f8f8f8; text-align:left; }
  .test-input { width:100%; max-width:120px; }
</style>

<div class="content-container">
  <div class="toolbar">
    <a class="btn" href="{% url 'tests_list' %}">Manage Tests</a>
    <a class="btn" href="{% url 'tests_summary' %}">Tests Summary</a>
    <a class="btn" href="{% url 'tests_manage_boxers' %}">Manage Boxers</a>
  </div>

  <!-- Step 1–3: boxer -> test -> season -->
  <form method="get" action="{% url 'tests_results' %}" class="inline-form" id="selector">
    <label>Boxer
      <select name="boxer" id="boxer" class="picker" required>
        <option value="">— Choose a boxer —</option>
        {% for b in boxers %}
          <option value="{{ b.id }}" {% if selected_boxer and selected_boxer.id == b.id %}selected{% endif %}>{{ b.name }}</option>
        {% endfor %}
      </select>
    </label>

    <label id="test-wrap" class="{% if not selected_boxer %}hidden{% endif %}">Battery test
      <select name="test" id="test" class="picker" {% if not selected_boxer %}disabled{% endif %} required>
        <option value="">— Choose a test —</option>
        {% for t in tests %}
          <option value="{{ t.id }}" {% if selected_test and selected_test.id == t.id %}selected{% endif %}>
            {{ t.name }}{% if t.unit %} [{{ t.unit }}]{% endif %}
          </option>
        {% endfor %}
      </select>
    </label>

    <label id="phase-wrap" class="{% if not selected_boxer or not selected_test %}hidden{% endif %}">Season
      <select name="phase" id="phase" class="picker" required>
        {% for value,label in phase_choices %}
          <option value="{{ value }}" {% if phase == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </label>

    <button class="btn" type="submit" id="go" {% if not selected_boxer or not selected_test %}disabled{% endif %}>Submit results</button>
  </form>

  {% if selected_boxer and selected_test %}
    <!-- Small editor table for ONE boxer × ONE test × ONE season -->
    <div style="margin-top:16px;">
      <h3>
        {{ selected_boxer.name }} —
        {{ selected_test.display_label|default:selected_test.name }}
        {% if selected_test.unit %} ({{ selected_test.unit }}){% endif %} —
        {{ phase|capfirst }}
      </h3>

      <form method="post" action="{% url 'tests_results' %}?boxer={{ selected_boxer.id }}&test={{ selected_test.id }}&phase={{ phase }}">
        {% csrf_token %}
        <input type="hidden" name="boxer_id" value="{{ selected_boxer.id }}">
        <input type="hidden" name="test_id" value="{{ selected_test.id }}">
        <input type="hidden" name="phase" value="{{ phase }}">

        <table class="result-table">
          <thead>
            <tr>
              <th>Measurement 1</th>
              <th>Measurement 2</th>
              <th>Measurement 3</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><input class="test-input" type="number" step="0.01" name="value1" value="{{ result.value1|default_if_none:'' }}" inputmode="decimal"></td>
              <td><input class="test-input" type="number" step="0.01" name="value2" value="{{ result.value2|default_if_none:'' }}" inputmode="decimal"></td>
              <td><input class="test-input" type="number" step="0.01" name="value3" value="{{ result.value3|default_if_none:'' }}" inputmode="decimal"></td>
              <td><input type="text" name="notes" value="{{ result.notes|default_if_none:'' }}" style="width:100%"></td>
            </tr>
          </tbody>
        </table>

        <div style="margin-top:10px;">
          <button class="btn" type="submit">Save</button>
          <a class="btn" href="{% url 'tests_results' %}?boxer={{ selected_boxer.id }}&test={{ selected_test.id }}&phase={{ phase }}">Reset</a>
        </div>
      </form>
    </div>
  {% endif %}
</div>

<script>
  const boxer = document.getElementById('boxer');
  const test  = document.getElementById('test');
  const testWrap  = document.getElementById('test-wrap');
  const phaseWrap = document.getElementById('phase-wrap');
  const goBtn = document.getElementById('go');

  function sync() {
    const hasBoxer = boxer.value !== '';
    const hasTest  = test && test.value !== '';

    if (hasBoxer) {
      test.removeAttribute('disabled');
      testWrap.classList.remove('hidden');
    } else {
      test.value = '';
      test.setAttribute('disabled','disabled');
      testWrap.classList.add('hidden');
    }

    if (hasBoxer && hasTest) {
      phaseWrap.classList.remove('hidden');
      goBtn.removeAttribute('disabled');
    } else {
      phaseWrap.classList.add('hidden');
      goBtn.setAttribute('disabled','disabled');
    }
  }

  if (boxer) boxer.addEventListener('change', sync);
  if (test)  test.addEventListener('change', sync);
  sync();
</script>
{% endblock %}
