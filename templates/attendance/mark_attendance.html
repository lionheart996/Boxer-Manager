{% extends "base.html" %}
{% block content %}
<div class="content-container">
  <h2 class="page-title">Mark Attendance</h2>

  <!-- Class + Date selector (GET) -->
  <form method="get" class="form-row selector-bar">
    <label>Class:</label>
    <select name="class_id" onchange="this.form.submit()">
      <option value="">-- Choose a class --</option>
      {% for c in classes %}
        <option value="{{ c.id }}" {% if selected_class and selected_class.id == c.id %}selected{% endif %}>
          {{ c.title }}
        </option>
      {% endfor %}
    </select>

    <label>Date:</label>
    <input type="date" name="date" value="{{ date|date:'Y-m-d' }}" onchange="this.form.submit()">

    <noscript><button class="btn" type="submit">Apply</button></noscript>
    <a class="btn btn--accent" href="{% url 'attendance_list' %}">All Attendance</a>

    {% if selected_class and not class_create_form.errors %}
      <button type="button"
              id="add-class-toggle"
              class="btn btn--quiet">
        Add a class
      </button>
    {% endif %}
  </form>

  <!-- Add Class form -->
  <div id="add-class-panel"
       class="add-class-panel"
       {% if selected_class and not class_create_form.errors %}hidden{% endif %}>
    <div class="card add-class-card">
      <div class="add-class-head">
        <h3 style="margin:0;">Add Class</h3>
        <button type="button" id="add-class-close" class="btn btn--quiet btn--sm" style="margin-left:auto;">Close</button>
      </div>
      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="create_class">
        {{ class_create_form.as_p }}
        <button class="btn btn--primary" type="submit">Add</button>
      </form>
    </div>
  </div>

  {% if selected_class %}
  <!-- ENROLL / REMOVE BOXERS -->
  <div class="card enroll-card">
    <h3>Enroll Boxer — {{ selected_class.title }}</h3>

    <form method="post" class="enroll-form">
      {% csrf_token %}
      <input type="hidden" name="action" value="enroll">
      <input type="hidden" name="class_id" value="{{ selected_class.id }}">
      {{ enroll_form.as_p }}
      <button class="btn btn--primary btn--sm" type="submit">Enroll</button>
    </form>

    <h4 class="enrolled-title">Enrolled</h4>
    <ul class="enrolled-list">
      {% for b in boxers %}
        <li class="enrolled-item">
          <span class="enrolled-name">{{ b.first_name }} {{ b.last_name }}</span>
          <form method="post" class="inline" onsubmit="return confirm('Remove {{ b.first_name }} {{ b.last_name }} from this class?');">
            {% csrf_token %}
            <input type="hidden" name="action" value="unenroll">
            <input type="hidden" name="class_id" value="{{ selected_class.id }}">
            <input type="hidden" name="boxer_id" value="{{ b.id }}">
            <button class="btn btn--danger btn--sm" type="submit">Remove</button>
          </form>
        </li>
      {% empty %}
        <li class="enrolled-empty">No boxers enrolled yet.</li>
      {% endfor %}
    </ul>
  </div>

  <!-- ATTENDANCE -->
  <form id="mark-form" method="post" onsubmit="return confirm('Submit attendance?');">
    {% csrf_token %}
    <input type="hidden" name="class_id" value="{{ selected_class.id }}">

    <p class="muted">Tip: typing a weight will auto-select “Present”.</p>

    <div class="attendance-list">
      {% for boxer in boxers %}
      <section class="att-card" data-boxer-id="{{ boxer.id }}">
        <header class="att-card__head">
          <h4 class="att-card__name">{{ boxer.first_name }} {{ boxer.last_name }}</h4>
          <a class="btn btn--sm btn--quiet att-card__progress" href="{% url 'weight_progress' boxer.id %}">
            Weight Progress
          </a>
        </header>

        <div class="att-card__controls">
          <!-- Present / Absent -->
          <fieldset class="segmented">
            <input id="p-{{ boxer.id }}" type="radio" name="attendance_{{ boxer.id }}" value="Present"
                   {% if boxer.id in attendance_map %}checked{% endif %}>
            <label for="p-{{ boxer.id }}">Present</label>

            <input id="a-{{ boxer.id }}" type="radio" name="attendance_{{ boxer.id }}" value="Absent">
            <label for="a-{{ boxer.id }}">Absent</label>
          </fieldset>

          <!-- Excused -->
          <label class="switch">
            <input type="checkbox" name="excused_{{ boxer.id }}" class="excused-toggle" disabled>
            <span class="slider"></span>
            <span class="switch__label">Excused?</span>
          </label>

          <!-- Weight -->
          <label class="weight">
            <span>Weight (kg)</span>
            <input type="number" step="0.1" min="0" name="weight_{{ boxer.id }}" inputmode="decimal" placeholder="e.g. 72.5">
          </label>
        </div>
      </section>
      {% endfor %}
    </div>

    <br>
    <button type="submit" class="btn btn--primary submit-btn">Submit Attendance</button>
  </form>
  {% else %}
    <p>Select a class above to enroll boxers and mark attendance.</p>
  {% endif %}

  <!-- Always show Export button -->
  <div style="text-align: right; margin-top: 2rem;">
    <a href="{% url 'export_form' %}{% if selected_class %}?class_id={{ selected_class.id }}{% endif %}"
       class="btn"
       style="color: black; background: #f0f0f0; border: 1px solid #ccc; border-radius: 8px; padding: 0.5rem 1rem; font-weight: 600; text-decoration: none;">
      Export Data
    </a>
  </div>
</div>


<style>
.selector-bar { gap:10px; margin-bottom:16px; flex-wrap:wrap; }

.add-class-panel[hidden] { display:none; }
.add-class-card { padding:12px; border:1px solid var(--border); border-radius:12px; background:var(--panel-2); }
.add-class-head { display:flex; align-items:center; gap:10px; margin-bottom:8px; }

.enroll-card{ padding:12px; border:1px solid var(--border); border-radius:12px; margin:16px 0; background:var(--panel-2); }
.enroll-form{ display:grid; gap:10px; margin-bottom:10px; }
.enrolled-list{ list-style:none; padding:0; margin:0; display:grid; gap:8px; }
.enrolled-item{ display:flex; justify-content:space-between; align-items:center; gap:10px; padding:8px 10px; border:1px solid var(--border); border-radius:10px; background:#111; }
.enrolled-name{ font-weight:600; }

.attendance-list{ display:grid; gap:12px; margin-top:12px; }
.att-card{ background:#121212; border:1px solid var(--border); border-radius:12px; padding:14px; display:grid; gap:12px; }
.att-card__head{ display:flex; align-items:center; justify-content:space-between; }
.att-card__name{ margin:0; font-size:16px; font-weight:700; }

.segmented{ display:inline-grid; grid-template-columns:1fr 1fr; border:1px solid var(--border); border-radius:999px; overflow:hidden; }
.segmented input{ position:absolute; opacity:0; pointer-events:none; }
.segmented label{ padding:6px 12px; text-align:center; cursor:pointer; user-select:none; }
.segmented input:checked + label{ background:var(--brand); color:#000; }

.switch{ display:inline-flex; align-items:center; gap:8px; }
.switch input{ position:absolute; opacity:0; }
.switch .slider{ width:38px; height:22px; border-radius:999px; border:1px solid var(--border); background:#0f0f0f; position:relative; }
.switch .slider::after{ content:""; position:absolute; top:2px; left:2px; width:18px; height:18px; border-radius:50%; background:var(--muted); transition:left .2s ease; }
.switch input:checked + .slider{ background:var(--brand); }
.switch input:checked + .slider::after{ left:18px; background:#000; }
.switch .switch__label{ font-size:13px; color:var(--muted); }

.weight{ display:grid; gap:4px; }
.weight input{ width:120px; text-align:center; }

.att-card__controls{ display:grid; grid-template-columns:1fr auto 1fr; gap:10px; align-items:center; }
@media(max-width:520px){ .att-card__controls{ grid-template-columns:1fr; } }

.submit-btn{ width:100%; font-weight:700; border-radius:12px; }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const btn   = document.getElementById("add-class-toggle");
    const panel = document.getElementById("add-class-panel");
    const close = document.getElementById("add-class-close");

    if (btn && panel) {
      btn.addEventListener("click", () => {
        panel.hidden = false;
        btn.style.display = "none";
        const first = panel.querySelector("input, select, textarea");
        if (first) first.focus();
        panel.scrollIntoView({ behavior: "smooth", block: "start" });
      });
    }
    if (close && panel && btn) {
      close.addEventListener("click", () => {
        panel.hidden = true;
        btn.style.display = "";
      });
    }
  });

  document.addEventListener('input', e => {
    if(e.target.name && e.target.name.startsWith('weight_')){
      const id = e.target.name.split('_')[1];
      const present = document.querySelector(`input[name="attendance_${id}"][value="Present"]`);
      if(present && e.target.value.trim() !== '') present.checked = true;
    }
  });

  document.addEventListener('change', e => {
    if(e.target.type === 'radio' && e.target.name.startsWith('attendance_')){
      const id = e.target.name.split('_')[1];
      const absent = e.target.value === 'Absent';
      const excused = document.querySelector(`input[name="excused_${id}"]`);
      const weight  = document.querySelector(`input[name="weight_${id}"]`);
      if(excused){ excused.disabled = !absent; if(!absent) excused.checked = false; }
      if(absent && weight) weight.value = '';
    }
  });

  document.querySelectorAll('[name^="attendance_"][value="Absent"]').forEach(radio=>{
    const id = radio.name.split('_')[1];
    const excused = document.querySelector(`input[name="excused_${id}"]`);
    if(excused) excused.disabled = !radio.checked;
  });
</script>
{% endblock %}
