{% extends "base.html" %}
{% block content %}
<div class="content-container">
  <h2 class="page-title">Mark Attendance</h2>

  <!-- Class + Date selector -->
  <form method="get" class="form-row selector-bar">
    <label>Class:</label>
    <select name="class_id" onchange="this.form.submit()">
      <option value="">-- Choose a class --</option>
      {% for c in classes %}
        <option value="{{ c.id }}" {% if selected_class and selected_class.id == c.id %}selected{% endif %}>
          {{ c.title }}
        </option>
      {% endfor %}
    </select>

    <label>Date:</label>
    <input type="date" name="date" value="{{ date|date:'Y-m-d' }}" onchange="this.form.submit()">

    <noscript><button class="btn" type="submit">Apply</button></noscript>
    <a class="btn btn--accent" href="{% url 'attendance_list' %}">All Attendance</a>

    {% if selected_class and not class_create_form.errors %}
      <button type="button" id="add-class-toggle" class="btn btn--quiet">Add a class</button>
    {% endif %}
  </form>

  <!-- Add Class form panel -->
  <div id="add-class-panel"
       class="add-class-panel"
       {% if selected_class and not class_create_form.errors %}hidden{% endif %}>
    <div class="card add-class-card">
      <div class="add-class-head">
        <h3 style="margin:0;">Add Class</h3>
        <button type="button" id="add-class-close" class="btn btn--quiet btn--sm" style="margin-left:auto;">Close</button>
      </div>
      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="create_class">
        {{ class_create_form.as_p }}
        <button class="btn btn--primary" type="submit">Add</button>
      </form>
    </div>
  </div>

  {% if selected_class %}
  <!-- ENROLL / REMOVE BOXERS -->
  <div class="card enroll-card">
    <h3>Enroll Boxer — {{ selected_class.title }}</h3>

    <form method="post" class="enroll-form">
      {% csrf_token %}
      <input type="hidden" name="action" value="enroll">
      <input type="hidden" name="class_id" value="{{ selected_class.id }}">
      {{ enroll_form.as_p }}
      <button class="btn btn--primary btn--sm" type="submit">Enroll</button>
    </form>

    <h4 class="enrolled-title">Enrolled</h4>
    <ul class="enrolled-list">
      {% for b in boxers %}
        <li class="enrolled-item">
          <div class="enrolled-info">
            <div class="enrolled-avatar">{{ b.first_name|slice:":1" }}{{ b.last_name|slice:":1" }}</div>
            <span class="enrolled-name">
              {% if b.first_name or b.last_name %}
                {{ b.first_name }} {{ b.last_name }}
              {% else %}
                {{ b.name }}
              {% endif %}
            </span>
          </div>
          <form method="post" class="inline" onsubmit="return confirm('Remove {{ b.first_name }} {{ b.last_name }} from this class?');">
            {% csrf_token %}
            <input type="hidden" name="action" value="unenroll">
            <input type="hidden" name="class_id" value="{{ selected_class.id }}">
            <input type="hidden" name="boxer_id" value="{{ b.id }}">
            <button class="btn btn--danger btn--sm" type="submit">✕</button>
          </form>
        </li>
      {% empty %}
        <li class="enrolled-empty">No boxers enrolled yet.</li>
      {% endfor %}
    </ul>
  </div>

  <!-- ATTENDANCE -->
  <form id="mark-form" method="post" onsubmit="return confirm('Submit attendance?');">
    {% csrf_token %}
    <input type="hidden" name="class_id" value="{{ selected_class.id }}">

    <p class="muted">Tip: typing a weight will auto-select “Present”.</p>

    <div class="attendance-list">
      {% for item in boxer_data %}
      {% with boxer=item.boxer status=item.status excused=item.excused %}
      <section class="att-card" data-boxer-id="{{ boxer.id }}">
        <header class="att-card__head">
          <div class="att-boxer">
            <div class="att-avatar">{{ boxer.first_name|slice:":1" }}{{ boxer.last_name|slice:":1" }}</div>
            <h4 class="att-card__name">{{ boxer.first_name }} {{ boxer.last_name }}</h4>
          </div>
          <a class="btn btn--sm btn--quiet att-card__progress" href="{% url 'weight_progress' boxer.id %}">Weight Progress</a>
        </header>

        <div class="att-card__controls">
          <!-- Present / Absent -->
          <fieldset class="segmented">
            <input id="p-{{ boxer.id }}" type="radio" name="attendance_{{ boxer.id }}" value="Present"
                   {% if status == "present" %}checked{% endif %}>
            <label for="p-{{ boxer.id }}" class="present-label {% if status == 'present' %}active{% endif %}">Present</label>

            <input id="a-{{ boxer.id }}" type="radio" name="attendance_{{ boxer.id }}" value="Absent"
                   {% if status in 'absent excused' %}checked{% endif %}>
            <label for="a-{{ boxer.id }}" class="absent-label {% if status in 'absent excused' %}active{% endif %} {% if status == 'excused' %}excused{% endif %}">Absent</label>
          </fieldset>

          <!-- Excused -->
          <label class="switch {% if status == 'excused' %}excused-active{% endif %}">
            <input type="checkbox" name="excused_{{ boxer.id }}" class="excused-toggle"
                   {% if excused %}checked{% endif %}
                   {% if status == 'present' or not status %}disabled{% endif %}>
            <span class="slider"></span>
            <span class="switch__label">Excused?</span>
          </label>

          <!-- Weight -->
          <label class="weight">
            <span>Weight (kg)</span>
            <input type="number" step="0.1" min="0" name="weight_{{ boxer.id }}" placeholder="e.g. 72.5">
          </label>
        </div>
      </section>
      {% endwith %}
      {% endfor %}
    </div>

    <br>
    <button type="button" id="mark-all-absent" class="btn btn--quiet" style="margin-bottom:10px;">
      Mark All Unmarked as Absent
    </button>


    <button type="submit" class="btn btn--primary submit-btn">Submit Attendance</button>
  </form>
  {% else %}
    <p>Select a class above to enroll boxers and mark attendance.</p>
  {% endif %}
</div>

<style>
/* Add-class panel */
.add-class-panel[hidden]{ display:none; }
.add-class-card{ padding:12px; border:1px solid var(--border); border-radius:12px; background:var(--panel-2); }
.add-class-head{ display:flex; align-items:center; gap:10px; margin-bottom:8px; }

/* Enrolled list */
.enrolled-title{ margin-top:1rem; margin-bottom:0.5rem; font-size:1.1rem; font-weight:700; color:var(--brand); text-transform:uppercase; letter-spacing:1px; }
.enrolled-list{ list-style:none; padding:0; margin:0; display:grid; gap:10px; }
.enrolled-item{ display:flex; justify-content:space-between; align-items:center; padding:10px 14px; border:1px solid var(--border); border-radius:12px; background:linear-gradient(145deg,#151515,#101010); box-shadow:0 2px 6px rgba(0,0,0,0.5); transition:transform 0.2s ease, box-shadow 0.3s ease; }
.enrolled-item:hover{ transform:translateY(-2px); box-shadow:0 4px 12px rgba(0,0,0,0.7), 0 0 8px var(--brand); }
.enrolled-info{ display:flex; align-items:center; gap:10px; }
.enrolled-avatar{ width:32px; height:32px; border-radius:50%; background:var(--brand); color:#000; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:14px; text-transform:uppercase; }
.enrolled-name{ font-weight:600; font-size:0.95rem; color:#eee; }

/* Attendance cards */
.attendance-list{ display:grid; gap:12px; margin-top:12px; }
.att-card{ background:#121212; border:1px solid var(--border); border-radius:12px; padding:14px; display:grid; gap:12px; transition:background 0.3s ease; }
.att-card__head{ display:flex; align-items:center; justify-content:space-between; }
.att-boxer{ display:flex; align-items:center; gap:10px; }
.att-avatar{ width:36px; height:36px; border-radius:50%; background:var(--brand); color:#000; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:15px; text-transform:uppercase; }
.att-card__name{ margin:0; font-size:16px; font-weight:700; }

/* Controls */
.att-card__controls{ display:grid; grid-template-columns:1fr auto 1fr; gap:10px; align-items:center; }
@media(max-width:520px){ .att-card__controls{ grid-template-columns:1fr; } }

/* Segmented controls */
.segmented{ display:inline-grid; grid-template-columns:1fr 1fr; border:1px solid var(--border); border-radius:999px; overflow:hidden; }
.segmented input{ position:absolute; opacity:0; pointer-events:none; }
.segmented label{ padding:6px 12px; text-align:center; cursor:pointer; user-select:none; transition:all 0.3s ease; }
.present-label.active{ background:#00ff66; color:#000; }
.absent-label.active{ background:#ff3333; color:#fff; }
.absent-label.excused{ background:#ffcc00 !important; color:#000; }

/* Excused toggle */
.switch{ display:inline-flex; align-items:center; gap:8px; }
.switch input{ position:absolute; opacity:0; }
.switch .slider{ width:38px; height:22px; border-radius:999px; border:1px solid var(--border); background:#0f0f0f; position:relative; transition:all .2s; }
.switch .slider::after{ content:""; position:absolute; top:2px; left:2px; width:18px; height:18px; border-radius:50%; background:var(--muted); transition:left .2s ease, background .2s ease; }
.switch input:checked + .slider{ background:var(--brand); }
.switch input:checked + .slider::after{ left:18px; background:#000; }
.switch.excused-active .slider{ background:#ffcc00 !important; }

/* Weight */
.weight{ display:grid; gap:4px; }
.weight input{ width:120px; text-align:center; }

/* Submit */
.submit-btn{ width:100%; font-weight:700; border-radius:12px; }

#mark-all-absent{
  width: 100%;
  border-radius: 12px;
  font-weight: 600;
    background-color: #00c3ff;
}

</style>

<script>
/* ===========================
   Attendance card interactions
   =========================== */
function updateCardState(card) {
  const present = card.querySelector('input[value="Present"]');
  const absent  = card.querySelector('input[value="Absent"]');
  const excused = card.querySelector('.excused-toggle');
  const presentLabel = card.querySelector('.present-label');
  const absentLabel  = card.querySelector('.absent-label');
  const switchLabel  = card.querySelector('.switch');

  // reset visual state
  presentLabel?.classList.remove('active');
  absentLabel?.classList.remove('active','excused');
  switchLabel?.classList.remove('excused-active');

  if (present?.checked) {
    presentLabel?.classList.add('active');
    if (excused) { excused.checked = false; excused.disabled = true; }
  } else if (absent?.checked) {
    absentLabel?.classList.add('active');
    if (excused) {
      excused.disabled = false;
      if (excused.checked) {
        absentLabel?.classList.add('excused');
        switchLabel?.classList.add('excused-active');
      }
    }
  }
}

/* ===========================
   Unsaved attendance guard
   =========================== */
let attendanceDirty = false;
function hasAnyMarkOnCard(card) {
  const present = card.querySelector('input[value="Present"]');
  const absent  = card.querySelector('input[value="Absent"]');
  const weight  = card.querySelector('input[name^="weight_"]');
  const excused = card.querySelector('.excused-toggle');
  return !!(
    (present && present.checked) ||
    (absent  && absent.checked)  ||
    (weight  && weight.value.trim() !== '') ||
    (excused && excused.checked)
  );
}
function recomputeDirtyFlag() {
  attendanceDirty = Array.from(document.querySelectorAll('.att-card')).some(hasAnyMarkOnCard);
}

/* ===========================
   Futuristic warning modal
   =========================== */
function showAttentionModal(message, onConfirm) {
  // Create modal only once
  let modal = document.getElementById("attention-modal");
  if (!modal) {
    modal = document.createElement("div");
    modal.id = "attention-modal";
    modal.innerHTML = `
      <div class="attention-card" onclick="event.stopPropagation()">
        <h3>⚠️ Attention</h3>
        <p class="attention-msg"></p>
        <div class="attention-actions">
          <button class="btn-cancel">Cancel</button>
          <button class="btn-confirm">Continue</button>
        </div>
      </div>`;
    document.body.appendChild(modal);

    // Add styles
    const style = document.createElement("style");
    style.textContent = `
      #attention-modal {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(5px);
        z-index: 10000;
      }
      #attention-modal.active { display: flex; }
      .attention-card {
        background: #111;
        border: 1px solid #00ffcc;
        border-radius: 14px;
        padding: 20px;
        width: min(420px, 90vw);
        box-shadow: 0 0 25px rgba(0,255,150,.4);
        text-align: center;
        color: #fff;
      }
      .attention-card h3 {
        color: #00ffcc;
        margin-bottom: 10px;
        font-size: 1.4rem;
      }
      .attention-msg { color: #ddd; font-size: 0.95rem; margin-bottom: 20px; }
      .attention-actions {
        display: flex;
        justify-content: center;
        gap: 12px;
      }
      .attention-actions button {
        border: none;
        border-radius: 10px;
        padding: 10px 16px;
        font-weight: 700;
        cursor: pointer;
      }
      .btn-cancel {
        background: #333;
        color: #ddd;
      }
      .btn-confirm {
        background: #00ff66;
        color: #000;
      }
      .btn-cancel:hover { background: #444; }
      .btn-confirm:hover { background: #00ffaa; }
    `;
    document.head.appendChild(style);
  }

  modal.querySelector(".attention-msg").textContent = message;
  modal.classList.add("active");

  const cancelBtn = modal.querySelector(".btn-cancel");
  const confirmBtn = modal.querySelector(".btn-confirm");

  cancelBtn.onclick = () => modal.classList.remove("active");
  confirmBtn.onclick = () => {
    modal.classList.remove("active");
    if (onConfirm) onConfirm();
  };
}

/* Replace confirmIfDirty */
function confirmIfDirty(e) {
  if (!attendanceDirty) return true;

  e.preventDefault();
  e.stopPropagation();

  showAttentionModal(
    "Are you sure you want to enroll this boxer without saving the current attendancies? Continuing will remove all unsaved attendancies.",
    () => {
      attendanceDirty = false;
      e.target.closest("form").submit();
    }
  );
  return false;
}

/* =====================================
   Initialize after DOM is ready
   ===================================== */
document.addEventListener('DOMContentLoaded', () => {
  /* ----- Card behavior (dataset-based lastClicked) ----- */
  document.querySelectorAll('.att-card').forEach(card => {
    const present = card.querySelector('input[value="Present"]');
    const absent  = card.querySelector('input[value="Absent"]');

    card.dataset.lastClicked = '';

    [present, absent].forEach(input => {
      if (!input) return;
      input.addEventListener('click', e => {
        const v = input.value;
        const last = card.dataset.lastClicked || '';
        if (last === v && input.checked) {
          e.preventDefault();
          input.checked = false;
          card.dataset.lastClicked = '';
        } else {
          card.dataset.lastClicked = v;
        }
        updateCardState(card);
        recomputeDirtyFlag();
      });
    });

    card.addEventListener('change', e => {
      if (e.target.matches('.excused-toggle')) {
        updateCardState(card);
        recomputeDirtyFlag();
      }
    });

    card.addEventListener('input', e => {
      if (e.target.name && e.target.name.startsWith('weight_')) {
        if (present && absent) {
          if (e.target.value.trim() !== '') {
            present.checked = true; absent.checked = false;
            card.dataset.lastClicked = 'Present';
          }
          updateCardState(card);
          recomputeDirtyFlag();
        }
      }
    });

    updateCardState(card);
  });

  /* ----- Add-class panel toggle ----- */
  document.getElementById('add-class-toggle')?.addEventListener('click', () => {
    const panel = document.getElementById('add-class-panel'); if (panel) panel.hidden = false;
  });
  document.getElementById('add-class-close')?.addEventListener('click', () => {
    const panel = document.getElementById('add-class-panel'); if (panel) panel.hidden = true;
  });

  /* ----- Guard on enroll/unenroll submits ----- */
  const markForm = document.getElementById('mark-form');
  markForm?.addEventListener('submit', () => { attendanceDirty = false; });
  document.querySelector('.enroll-form')?.addEventListener('submit', confirmIfDirty);
  document.querySelectorAll('form.inline').forEach(f => f.addEventListener('submit', confirmIfDirty));

  /* ===========================
     Mark All Unmarked as Absent
     =========================== */
  function isCardUnmarked(card) {
    const present = card.querySelector('input[value="Present"]');
    const absent  = card.querySelector('input[value="Absent"]');
    const weight  = card.querySelector('input[name^="weight_"]');
    return !((present && present.checked) || (absent && absent.checked) || (weight && weight.value.trim() !== ''));
  }

  function forceAbsent(card) {
    const present = card.querySelector('input[value="Present"]');
    const absent  = card.querySelector('input[value="Absent"]');
    const excused = card.querySelector('.excused-toggle');
    if (!absent) return;
    card.dataset.lastClicked = '';
    if (present) present.checked = false;
    absent.checked = true;
    if (excused) { excused.disabled = false; excused.checked = false; }
    updateCardState(card);
  }

  const markAllBtn = document.getElementById('mark-all-absent');
  if (markAllBtn) {
    markAllBtn.addEventListener('click', () => {
      document.querySelectorAll('.att-card').forEach(card => {
        if (isCardUnmarked(card)) forceAbsent(card);
      });
      recomputeDirtyFlag();
    });
  }

  /* ====== Add loading overlay without changing template ====== */
  (function attachLoadingOverlay() {
    const form = document.getElementById('mark-form');
    if (!form) return;
    const hadInline = form.getAttribute('onsubmit');
    if (hadInline) form.removeAttribute('onsubmit');

    form.addEventListener('submit', function(e) {
      const ok = window.confirm('Submit attendance?');
      if (!ok) {
        e.preventDefault();
        e.stopImmediatePropagation();
        return false;
      }
      const overlay = document.getElementById('att-loading-overlay');
      if (overlay) {
        overlay.classList.add('att-active');
      }
      return true;
    });
  })();
});
</script>
<!-- ===== Futuristic Loading Overlay (no conflicts) ===== -->
<div id="att-loading-overlay">
  <div class="att-loading-spinner"></div>
  <p class="att-loading-text">⚡ Submitting attendance.</p>
</div>
<style>
#att-loading-overlay{
  position: fixed;
  inset: 0;
  background: radial-gradient(circle at center, rgba(0,255,136,0.12) 0%, rgba(0,0,0,0.92) 80%);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  backdrop-filter: blur(10px);
  z-index: 9999;
  opacity: 0;
  pointer-events: none;
  transition: opacity .25s ease;
}
#att-loading-overlay.att-active{
  opacity: 1;
  pointer-events: all;
}
.att-loading-spinner{
  width: 80px;
  height: 80px;
  border: 4px solid rgba(0,255,136,0.25);
  border-top-color: #00ff88;
  border-radius: 50%;
  animation: att_spin 1.1s linear infinite, att_glow 2s ease-in-out infinite;
  box-shadow: 0 0 18px rgba(0,255,136,0.35);
}
.att-loading-text{
  margin-top: 18px;
  color: #00ff88;
  font-size: 1.35rem;
  font-weight: 800;
  letter-spacing: 2px;
  text-shadow: 0 0 12px rgba(0,255,136,0.8);
  animation: att_pulse 1.2s ease-in-out infinite;
}
@keyframes att_spin { to { transform: rotate(360deg); } }
@keyframes att_glow {
  0%,100% { box-shadow: 0 0 14px rgba(0,255,136,0.35); }
  50% { box-shadow: 0 0 28px rgba(0,255,136,0.7); }
}
@keyframes att_pulse {
  0%,100% { opacity: .75; transform: scale(1); }
  50% { opacity: 1; transform: scale(1.08); }
}
</style>

{% endblock %}
