{% extends "base.html" %}
{% block content %}
<h2 class="page-title">üìÖ Attendance</h2>

<div class="content-container">

  <!-- Filters -->
  <form method="get" class="filter-bar" id="filter-form">
    <div class="date-field">
      <input type="date" id="date" name="date" value="{{ date }}">
      <span class="calendar-icon" onclick="document.getElementById('date').showPicker?.()">üìÖ</span>
    </div>
    <input type="text" name="q" value="{{ q }}" placeholder="Search boxer‚Ä¶" />
    <button class="btn btn--primary" type="submit" data-loading>Filter</button>
    <a class="btn btn--quiet" href="{% url 'attendance_list' %}" data-loading>Clear</a>

    {% if show_absences %}
      <a class="btn btn--secondary" href="?date={{ date }}&q={{ q }}" data-loading>Show Present</a>
    {% else %}
      <a class="btn btn--secondary" href="?date={{ date }}&q={{ q }}&show_absences=1" data-loading>Show Absences</a>
    {% endif %}
  </form>

  {% if presence_mode %}
    <!-- Sentence mode -->
    <p class="presence-result">
      {{ presence_name }}
      {% if presence_status == "present" %}
        <span class="present">was</span> present
      {% elif presence_status == "excused" %}
        <span class="excused">was excused</span>
      {% else %}
        <span class="absent">was NOT</span> present
      {% endif %}
      on {{ presence_date }}
    </p>

  {% else %}
    <!-- List mode -->
    {% if attendances %}
      <div class="attendance-list">
        {% for a in attendances %}
          <div
            class="att-card"
            data-boxer="{{ a.boxer.id }}"
            data-edit-url="{% url 'attendance_edit' a.id %}"
            data-delete-url="{% url 'attendance_delete' a.id %}"
            data-date="{{ a.date|date:'Y-m-d' }}"
            data-status="{% if a.is_present %}present{% elif a.is_excused %}excused{% else %}absent{% endif %}"
          >
            <div class="att-main">
              <!-- Full date for desktop, compact for mobile -->
              <div class="att-date att-date--desktop">{{ a.date|date:"d M Y (D)" }}</div>
              <div class="att-date att-date--mobile" data-date="{{ a.date|date:'Y-m-d' }}"></div>

              <div class="att-boxer">{{ a.boxer.first_name }} {{ a.boxer.last_name }}</div>
              <div class="att-class">
                {% if show_absences %}
                  {% if a.is_excused %}
                    <span class="excused">Excused</span>
                  {% else %}
                    <span class="absent">Unexcused</span>
                  {% endif %}
                {% else %}
                  <span class="present">Present</span>
                {% endif %}
                ‚Äì {% if a.class_template %}{{ a.class_template.title }}{% else %}‚Äì{% endif %}
              </div>

              <!-- Right-side actions -->
              <div class="att-actions">
                <button type="button" class="icon-btn attm-edit-btn" title="Edit" aria-label="Edit">‚úèÔ∏è</button>
                <button type="button" class="icon-btn attm-del-btn" title="Delete" aria-label="Delete">üóëÔ∏è</button>
              </div>
            </div>

            <!-- Dropdown popup -->
            <div class="att-dropdown">
              <a href="{% url 'boxer_report' a.boxer.id %}" class="dropdown-btn" data-loading>üìä Report</a>
              <a href="{% url 'boxer_resume' a.boxer.id %}" class="dropdown-btn" data-loading>üìÑ Resume</a>
              <a href="{% url 'boxer_comments' a.boxer.id %}" class="dropdown-btn" data-loading>üí¨ Comments</a>
            </div>
          </div>
        {% endfor %}
      </div>

      {% if is_paginated %}
        <div class="pagination">
          {% if page_obj.has_previous %}
            <a class="btn" href="?page={{ page_obj.previous_page_number }}&date={{ date }}&q={{ q }}{% if show_absences %}&show_absences=1{% endif %}" data-loading>‚Üê Prev</a>
          {% endif %}
          <span>Page {{ page_obj.number }} of {{ paginator.num_pages }}</span>
          {% if page_obj.has_next %}
            <a class="btn" href="?page={{ page_obj.next_page_number }}&date={{ date }}&q={{ q }}{% if show_absences %}&show_absences=1{% endif %}" data-loading>Next ‚Üí</a>
          {% endif %}
        </div>
      {% endif %}
    {% else %}
      <p><em>No attendance records found.</em></p>
    {% endif %}
  {% endif %}
</div>

<!-- Edit Modal -->
<div id="edit-modal-backdrop" aria-hidden="true">
  <div id="edit-modal" role="dialog" aria-modal="true" onclick="event.stopPropagation()">
    <h3>‚úèÔ∏è Edit Attendance</h3>
    <form id="edit-form" method="post" action="#">
      {% csrf_token %}
      <input type="hidden" name="next" value="{{ request.get_full_path }}">
      <div class="modal-row">
        <label for="edit-date">Date</label>
        <input type="date" id="edit-date" name="date" required>
      </div>
      <div class="modal-row">
        <label>Status</label>
        <div class="modal-status">
          <label><input type="radio" name="status" value="present"> Present</label>
          <label><input type="radio" name="status" value="absent"> Absent</label>
          <label><input type="radio" name="status" value="excused"> Excused</label>
        </div>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn-cancel" id="modal-cancel">Cancel</button>
        <button type="submit" class="btn-save" data-loading>Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Hidden Delete Form -->
<form id="delete-form" method="post" style="display:none;">{% csrf_token %}
  <input type="hidden" name="next" value="{{ request.get_full_path }}">
</form>

<!-- Loading Overlay -->
<div id="loading-overlay">
  <div class="spinner"></div>
  <p>Loading...</p>
</div>

<style>
.present { color: #00cc55; }
.excused { color: #fafa68; }
.absent  { color: #b31010; }

.attendance-list { display: grid; gap: 14px; }
.att-card {
  background: linear-gradient(145deg, #0e0e0e, #181818);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 14px;
  position: relative;
  cursor: pointer;
  z-index: 1;
  transition: transform .2s ease, box-shadow .3s ease, border-color .2s ease;
  box-shadow: 0 8px 18px rgba(0,0,0,.45), inset 0 0 0 1px rgba(0,255,120,.06);
}
.att-card:hover { transform: translateY(-2px); box-shadow: 0 0 18px rgba(0,255,102,.25); }
.att-card.open { z-index: 10000; }

.att-main { display: grid; grid-template-columns: 1fr 2fr 1fr auto; gap: 10px; align-items: center; }
.att-date { font-weight:700; color:var(--brand); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.att-boxer { font-size:15px; font-weight:600; color:#fff; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.att-class { font-size:13px; color:var(--muted); text-align:right; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

.att-actions { display:flex; gap:8px; justify-content:flex-end; }
.icon-btn {
  background: rgba(20,20,20,.9);
  border: 1px solid rgba(0,255,150,.25);
  width: 34px; height: 34px;
  border-radius: 10px;
  cursor: pointer; font-size: 18px; line-height: 1;
  color: #bfffe8;
  transition: transform .12s ease, box-shadow .2s ease, border-color .2s ease, color .2s ease;
  box-shadow: 0 0 10px rgba(0,255,150,0.18);
}
.icon-btn:hover { transform: translateY(-1px) scale(1.04); border-color: rgba(0,255,150,0.5); color:#00ff99; }

.att-dropdown {
  display:none; position:absolute; top:calc(100% + 6px); right:14px;
  background:#111; border:1px solid var(--border); border-radius:12px;
  min-width:180px; box-shadow:0 8px 20px rgba(0,0,0,0.8); z-index:10001;
  animation:fadeIn .2s ease;
}
.att-card.open .att-dropdown { display:block; }

.dropdown-btn {
  display:block; padding:14px 18px; margin:4px; border-radius:8px;
  background:#1a1a1a; font-weight:600; color:#00ffcc; text-decoration:none;
  text-align:center; transition:all .2s ease; box-shadow:0 2px 6px rgba(0,0,0,.6);
}
.dropdown-btn:hover,
.dropdown-btn:active {
  background:#00ff66; color:#000; transform:scale(1.05);
  box-shadow:0 0 10px #00ff66;
}

/* Modal */
#edit-modal-backdrop{
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,.7); backdrop-filter:blur(4px);
  z-index:20000; align-items:center; justify-content:center;
}
#edit-modal{
  background:#111; border:1px solid #00ffcc; border-radius:14px;
  padding:16px; width:min(420px,92vw); max-height:90vh; overflow:auto;
  box-shadow:0 10px 30px rgba(0,255,120,.35); color:#fff;
}
#edit-modal h3{ margin:0 0 10px 0; color:#00ffcc; }
.modal-row{ margin:10px 0; display:grid; gap:6px; }
.modal-row label{ font-weight:600; color:#ddd; }
.modal-status label{ margin-right:12px; }
.modal-actions{ display:flex; justify-content:flex-end; gap:10px; margin-top:14px; }
.btn-cancel,.btn-save{ border:none; border-radius:10px; padding:10px 14px; font-weight:700; }
.btn-cancel{ background:#333; color:#ddd; }
.btn-save{ background:#00ff66; color:#000; }

/* Loading overlay */
#loading-overlay{
  display:none; position:fixed; inset:0;
  background: rgba(0,0,0,.86);
  color:#00ffcc; font-size:18px; font-weight:700;
  z-index:30000;
  align-items:center; justify-content:center; flex-direction:column;
}
#loading-overlay.active{ display:flex; }
.spinner{ width:56px; height:56px; border:4px solid rgba(0,255,150,.25); border-top:4px solid #00ff99; border-radius:50%; animation:spin .8s linear infinite; margin-bottom:12px; }
@keyframes spin{ to { transform: rotate(360deg); } }

/* Compact date visibility rules */
.att-date--mobile { display:none; }
@media (max-width: 640px) {
  .att-date--desktop { display: none; }
  .att-date--mobile {
    display: inline;
    font-weight: 700;
    color: var(--brand);
    white-space: normal;        /* ‚úÖ allow wrap */
    overflow: visible;          /* ‚úÖ show full text */
  }

      .att-boxer {
      white-space: normal;        /* ‚úÖ allow wrapping */
      overflow: visible;          /* ‚úÖ show full name */
      line-height: 1.3;
      word-break: break-word;     /* ‚úÖ break long names gracefully */
      font-size: 14px;
          margin-bottom: 2px;/* slightly smaller if needed */
    }

    /* Let the entire card grow vertically if the name wraps */
    .att-card {
      min-height: unset;          /* remove any fixed height */
      padding-top: 10px;
      padding-bottom: 10px;
    }

    /* Slightly adjust grid so columns breathe better on mobile */
    .att-main {
      grid-template-columns: 1.3fr 2.5fr 1fr auto;  /* ‚úÖ a bit more space for names */
      align-items: start;                            /* top-align content when wrapping */
    }

  /* Give the date column a bit more space on mobile */
  .att-main {
    grid-template-columns: 1.2fr 2fr 1fr auto;
  }

  .att-dropdown {
    left: 10px;
    right: 10px;
    min-width: unset;
    width: calc(100% - 20px);
  }

  .dropdown-btn {
    font-size: 17px;
    padding: 18px;
  }
}
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const loading = document.getElementById("loading-overlay");
  const editModal = document.getElementById("edit-modal-backdrop");
  const editForm  = document.getElementById("edit-form");
  const deleteForm = document.getElementById("delete-form");

  document.addEventListener("click", function(e) {
    const allCards = document.querySelectorAll(".att-card");
    const isIcon = e.target.closest(".icon-btn");
    const card = e.target.closest(".att-card");
    if (isIcon) return;
    if (card) {
      if (card.classList.contains("open")) {
        card.classList.remove("open");
      } else {
        allCards.forEach(c => c.classList.remove("open"));
        card.classList.add("open");
      }
    } else {
      allCards.forEach(c => c.classList.remove("open"));
    }
  });

  document.addEventListener("click", function(e){
    if (e.target.closest(".att-dropdown")) e.stopPropagation();
  }, true);

  document.body.addEventListener("click", (e) => {
    const a = e.target.closest("[data-loading]");
    if (a && a.tagName === "A") loading.classList.add("active");
  });
  document.body.addEventListener("submit", (e) => {
    if (e.target.matches("form")) loading.classList.add("active");
  });

  document.addEventListener("click", (e) => {
    const btn = e.target.closest(".attm-edit-btn");
    if (!btn) return;
    e.preventDefault(); e.stopPropagation();
    const card = btn.closest(".att-card"); if (!card) return;
    editForm.action = card.dataset.editUrl;
    editForm.querySelector("#edit-date").value = card.dataset.date;
    editForm.querySelectorAll('input[name="status"]').forEach(r => {
      r.checked = (r.value === card.dataset.status);
    });
    editModal.style.display = "flex";
  });

  editForm.addEventListener("submit", () => loading.classList.add("active"));
  document.getElementById("modal-cancel").addEventListener("click", (e) => {
    e.preventDefault(); editModal.style.display = "none";
  });
  editModal.addEventListener("click", () => { editModal.style.display = "none"; });

  document.addEventListener("click", (e) => {
    const btn = e.target.closest(".attm-del-btn");
    if (!btn) return;
    e.preventDefault(); e.stopPropagation();
    const card = btn.closest(".att-card"); if (!card) return;
    if (!confirm("Delete this attendance record?")) return;
    deleteForm.action = card.dataset.deleteUrl;
    loading.classList.add("active");
    deleteForm.submit();
  });
});

/* ===== Compact date rendering for mobile ===== */
function monthToRoman(m) {
  const romans = ["I","II","III","IV","V","VI","VII","VIII","IX","X","XI","XII"];
  return romans[m - 1] || "";
}
function renderCompactDates() {
  const isMobile = window.matchMedia("(max-width:640px)").matches;
  document.querySelectorAll(".att-date--mobile").forEach(el => {
    const d = el.dataset.date;
    if (!d) return;
    const [y, m, day] = d.split("-").map(Number);
    if (isMobile) {
      const yy = String(y).slice(-2);
      el.textContent = `${day}.${monthToRoman(m)} '${yy}`;
    } else {
      // Clear text when resizing back to desktop
      el.textContent = "";
    }
  });
}
document.addEventListener("DOMContentLoaded", renderCompactDates);
window.addEventListener("resize", renderCompactDates);

</script>
{% endblock %}
