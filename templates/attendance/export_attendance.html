{% extends "base.html" %}
{% block content %}
<div class="export-container">
  <h2 class="export-title">üöÄ Export Attendance</h2>
  <p class="export-subtitle">Choose a class and date range to preview and export attendance data.</p>

  <form id="export-form" method="get" action="{% url 'export_attendance_excel' %}" class="export-form">
    <!-- Class selector -->
    <div class="form-group">
      <label for="class_id">üéì Class</label>
      <select name="class_id" id="class_id" required>
        <option value="">-- Select a class --</option>
        {% for c in classes %}
          <option value="{{ c.id }}">{{ c.title }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Start Date -->
    <div class="form-group">
      <label for="start_date">üìÖ Start Date</label>
      <input type="date" name="start_date" id="start_date" required>
    </div>

    <!-- End Date -->
    <div class="form-group">
      <label for="end_date">üìÖ End Date</label>
      <input type="date" name="end_date" id="end_date" required>
    </div>

    <!-- Buttons -->
    <button type="button" id="preview-btn" class="btn-preview" disabled>üëÄ Preview Data</button>
    <button type="submit" id="export-btn" class="btn-export" disabled>‚ö° Export Excel</button>
  </form>

  <!-- Preview Table -->
  <div id="preview-container" class="preview-container" hidden>
    <h3 class="preview-title">üìã Attendance Preview</h3>
    <table class="preview-table">
      <thead>
        <tr>
          <th class="col-boxer"><span class="header-text">Boxer</span></th>
          <th class="col-present"><span class="header-text">Presents</span></th>
          <th class="col-excused"><span class="header-text">Excused</span></th>
          <th class="col-absent"><span class="header-text">Unexcused</span></th>
        </tr>
      </thead>
      <tbody id="preview-body"></tbody>
    </table>
  </div>
</div>

<!-- Futuristic Loading Overlay (hidden by default) -->
<div id="loading-overlay" class="loading-overlay hidden">
  <div class="loading-spinner"></div>
  <p class="loading-text">‚ö° Previewing Data ...</p>
</div>

<style>
/* === MAIN CONTAINER === */
.export-container {
  max-width: 700px;
  margin: 40px auto;
  padding: 30px;
  border-radius: 20px;
  background: rgba(20, 20, 20, 0.85);
  backdrop-filter: blur(12px);
  border: 1px solid rgba(0, 255, 100, 0.3);
  box-shadow: 0 0 20px rgba(0, 255, 100, 0.25), inset 0 0 10px rgba(0, 255, 100, 0.05);
  text-align: center;
  animation: fadeIn 0.6s ease-out;
}

/* === TITLES === */
.export-title {
  font-size: 2rem;
  color: #00ff88;
  text-shadow: 0 0 12px rgba(0, 255, 136, 0.7);
  margin-bottom: 10px;
}
.export-subtitle {
  color: #bbb;
  margin-bottom: 25px;
  font-size: 1.05rem;
}

/* === FORM === */
.export-form {
  display: grid;
  gap: 20px;
  text-align: left;
  width: 100%;
}
.form-group {
  display: flex;
  flex-direction: column;
}
.form-group label {
  font-weight: 600;
  color: #eee;
  margin-bottom: 6px;
  font-size: 0.95rem;
}
select, input[type="date"] {
  width: 100%;
  padding: 12px 14px;
  border-radius: 12px;
  border: 1px solid #333;
  background: rgba(30, 30, 30, 0.9);
  color: #fff;
  font-size: 1rem;
  transition: all 0.3s ease;
}
select:focus, input[type="date"]:focus {
  border-color: #00ff88;
  box-shadow: 0 0 10px #00ff88;
  outline: none;
}
#class_id option { font-size: 0.85rem; padding: 6px 10px; }

/* === BUTTONS === */
.btn-preview, .btn-export {
  width: 100%;
  padding: 14px;
  border-radius: 14px;
  border: none;
  font-size: 1.1rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
}
.btn-preview {
  background: linear-gradient(135deg, #00c3ff, #0066ff);
  color: #fff;
  box-shadow: 0 0 12px rgba(0, 195, 255, 0.6);
}
.btn-preview:hover:enabled { transform: translateY(-3px); box-shadow: 0 0 20px rgba(0, 195, 255, 0.9); }
.btn-export {
  background: linear-gradient(135deg, #00ff88, #00cc66);
  color: #000;
  box-shadow: 0 0 12px rgba(0, 255, 136, 0.6);
}
.btn-export:hover:enabled { transform: translateY(-3px); box-shadow: 0 0 20px rgba(0, 255, 136, 0.9); }
.btn-preview:disabled, .btn-export:disabled { background:#333; color:#777; box-shadow:none; cursor:not-allowed; }

/* === PREVIEW TABLE === */
.preview-container {
  margin-top: 30px;
  text-align: left;
  width: 100%;
  overflow-x: auto;
}
.preview-table {
  width: 100%;
  border-collapse: collapse;
  border-radius: 12px;
  overflow: hidden;
  background: rgba(25, 25, 25, 0.9);
  box-shadow: 0 0 12px rgba(0, 255, 100, 0.2);
  table-layout: fixed;
}
.preview-table th, .preview-table td {
  padding: 12px;
  border-bottom: 1px solid #333;
  text-align: center;
  color: #eee;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.preview-table th {
  background: rgba(0, 255, 100, 0.2);
  font-weight: 700;
  text-shadow: 0 0 6px rgba(0, 255, 100, 0.5);
}
.preview-table tr:hover td { background: rgba(0, 255, 100, 0.05); }
.col-boxer   { text-align: left; width: 40%; }
.col-present { width: 20%; color: #00ff88; }
.col-excused { width: 20%; color: #ffcc00; }
.col-absent  { width: 20%; color: #ff4444; }

/* === MOBILE === */
@media (max-width: 640px) {
  .preview-table { font-size: 0.85rem; }
  .preview-table th, .preview-table td { padding: 8px; }
  .col-boxer { width: 60%; max-width: 0; }
  .preview-table td:first-child { text-align: left; }
  .preview-table th:not(:first-child), .preview-table td:not(:first-child) { width: 13%; }
  .col-present .header-text,
  .col-excused .header-text,
  .col-absent .header-text { display: none; }
  .col-present::after { content: "+";   color: #00ff88; font-weight: 800; }
  .col-excused::after { content: "+/-"; color: #ffcc00; font-weight: 800; }
  .col-absent::after  { content: "‚àí";   color: #ff4444; font-weight: 800; }
}

/* === FUTURISTIC LOADING OVERLAY === */
.loading-overlay {
  position: fixed;
  inset: 0;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  background: radial-gradient(circle at center, rgba(0,255,136,0.1) 0%, rgba(0,0,0,0.9) 80%);
  backdrop-filter: blur(8px);
  z-index: 9999;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}
.loading-overlay.active {
  opacity: 1;
  pointer-events: all;
}
.loading-spinner {
  width: 80px;
  height: 80px;
  border: 4px solid rgba(0,255,136,0.2);
  border-top-color: #00ff88;
  border-radius: 50%;
  animation: spin 1.2s linear infinite, glow 2s ease-in-out infinite;
}
.loading-text {
  color: #00ff88;
  margin-top: 18px;
  font-size: 1.4rem;
  font-weight: 700;
  text-shadow: 0 0 12px rgba(0, 255, 136, 0.8);
  letter-spacing: 2px;
  animation: pulseText 1.2s ease-in-out infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
@keyframes glow {
  0%,100% { box-shadow: 0 0 15px rgba(0,255,136,0.3); }
  50% { box-shadow: 0 0 30px rgba(0,255,136,0.7); }
}
@keyframes pulseText {
  0%,100% { opacity: 0.7; transform: scale(1); }
  50% { opacity: 1; transform: scale(1.08); }
}
</style>

<script>
const classSelect = document.getElementById('class_id');
const startDate = document.getElementById('start_date');
const endDate = document.getElementById('end_date');
const exportBtn = document.getElementById('export-btn');
const previewBtn = document.getElementById('preview-btn');
const previewContainer = document.getElementById('preview-container');
const previewBody = document.getElementById('preview-body');
const loadingOverlay = document.getElementById('loading-overlay');

// Date validation logic
function validateForm() {
  const ready = classSelect.value && startDate.value && endDate.value;
  exportBtn.disabled = !ready;
  previewBtn.disabled = !ready;
}
startDate.addEventListener('change', () => { endDate.min = startDate.value; validateForm(); });
endDate.addEventListener('change', () => { startDate.max = endDate.value; validateForm(); });
[classSelect, startDate, endDate].forEach(el => el.addEventListener('change', validateForm));

// Show loading overlay
function showLoading() { loadingOverlay.classList.add('active'); }
// Hide loading overlay
function hideLoading() { loadingOverlay.classList.remove('active'); }

// Preview data logic
previewBtn.addEventListener('click', async () => {
  const url = `{% url 'export_attendance_preview' %}?class_id=${classSelect.value}&start_date=${startDate.value}&end_date=${endDate.value}`;
  showLoading();

  try {
    const res = await fetch(url);
    const data = await res.json();

    previewBody.innerHTML = '';
    data.forEach(row => {
      previewBody.innerHTML += `
        <tr>
          <td title="${row.boxer}">${row.boxer}</td>
          <td>${row.present}</td>
          <td>${row.excused}</td>
          <td>${row.unexcused}</td>
        </tr>`;
    });
    previewContainer.hidden = false;
  } catch (err) {
    alert('‚ö†Ô∏è Failed to load preview. Please try again.');
  } finally {
    hideLoading();
  }
});
</script>
{% endblock %}
