{% extends "base.html" %}
{% block content %}

<main class="home-container">
  <h1 class="title">ü•ä Boxer Factory Control Panel ü•ä</h1>

  <!-- BOXER MANAGER -->
  <section class="card">
    <h2>‚öôÔ∏è Boxer Manager</h2>
    <div class="button-row">
      <a class="btn" href="{% url 'boxer_bulk_add' %}">‚ûï Add Boxer</a>
      <a class="btn" href="{% url 'boxer_list' %}">üìã Manage</a>
    </div>
  </section>

  <!-- BATTERY TESTS -->
  <section class="card">
    <h2>üß™ Battery Tests</h2>
    <div class="button-row">
      <a class="btn" href="{% url 'tests_list' %}">Manage Tests</a>
      <a class="btn" href="{% url 'tests_rankings' %}">Rankings</a>
      <a class="btn" href="{% url 'tests_record' %}">Record Singular</a>
      <a class="btn" href="{% url 'tests_record_multi' %}">Record Multiple</a>
    </div>
  </section>

  <!-- ATTENDANCE -->
  <section class="card">
    <h2>üìÜ Attendance</h2>
    <p class="subtitle">Quickly mark who‚Äôs present today.</p>
    <div class="button-row">
      <a class="btn" href="{% url 'mark_attendance' %}">Mark</a>
      <a class="btn" href="{% url 'attendance_list' %}">All Attendance</a>
      <a class="btn" href="{% url 'export_attendance' %}">Export</a>
    </div>
  </section>

  <!-- SPARRING FINDER -->
  <section class="card" id="sparring-finder">
    <h2>üí´ Class & Sparring Partner Finder</h2>
    <p class="subtitle">Select a class to view boxers ‚Äî or search by name.</p>

    <div class="selector">
      <div class="input-group">
        <label for="classSelect"><strong>Choose Class:</strong></label>
        <select id="classSelect" class="input-field">
          <option value="">‚Äî All / search mode ‚Äî</option>
          {% for cls in classes %}
            <option value="{{ cls.id }}">{{ cls.title }}</option>
          {% endfor %}
        </select>
      </div>

      <div id="searchBox" class="input-group">
        <label for="sparBoxerSearch"><strong>Search Boxer:</strong></label>
        <input type="text" id="sparBoxerSearch"
               placeholder="Start typing a name..."
               class="input-field" />
        <div id="searchResults" class="dropdown"></div>
      </div>
    </div>

    <div id="classBoxerList" class="results" style="display:none;"></div>
    <div id="sparResults" class="results">
      <p class="muted">Select a class or search a boxer to begin.</p>
    </div>
  </section>
</main>

<!-- ==================== FUTURISTIC STYLING ==================== -->
<style>
:root {
  --brand: #00ff88;
  --dark-bg: #0a0a0a;
  --card-bg: linear-gradient(145deg, #0f0f0f, #151515);
  --border: rgba(0, 255, 136, 0.25);
  --text: #e8ffe8;
}

body {
  background: var(--dark-bg);
  color: var(--text);
  font-family: 'Orbitron', sans-serif;
}

.home-container {
  max-width: 950px;
  margin: 0 auto;
  padding: 24px;
  display: flex;
  flex-direction: column;
  gap: 22px;
}

.title {
  text-align: center;
  color: var(--brand);
  font-size: 2rem;
  text-shadow: 0 0 15px rgba(0,255,136,0.5);
  letter-spacing: 1px;
  margin-bottom: 12px;
}

.card {
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 0 25px rgba(0,255,136,0.15);
  transition: all .3s ease;
}
.card:hover {
  transform: translateY(-3px);
  box-shadow: 0 0 35px rgba(0,255,136,0.4);
}
.card h2 {
  color: var(--brand);
  text-align: center;
  margin-bottom: 10px;
}
.subtitle {
  text-align: center;
  color: #aaa;
  font-size: 0.9rem;
  margin-bottom: 12px;
}

.button-row {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 12px;
}

.btn {
  border: 1px solid var(--brand);
  color: var(--brand);
  padding: 8px 16px;
  border-radius: 10px;
  background: transparent;
  font-weight: 600;
  transition: all .2s ease;
  text-decoration: none;
  box-shadow: 0 0 10px rgba(0,255,136,0.2);
}
.btn:hover {
  background: var(--brand);
  color: #000;
  box-shadow: 0 0 20px rgba(0,255,136,0.8);
}

.selector {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  margin-top: 10px;
}
.input-group {
  width: 100%;
  max-width: 450px;
  text-align: left;
}
.input-field {
  width: 100%;
  padding: 10px 14px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: #111;
  color: var(--text);
  transition: all 0.3s ease;
  font-size: 0.95rem;
}
.input-field:focus {
  border-color: var(--brand);
  box-shadow: 0 0 12px rgba(0,255,136,0.6);
  outline: none;
}

.dropdown {
  background: #0d0d0d;
  border: 1px solid var(--border);
  border-radius: 10px;
  margin-top: 6px;
  width: 100%;
  max-height: 180px;
  overflow-y: auto;
  display: none;
}

.results {
  margin-top: 20px;
  border-top: 1px solid var(--border);
  padding-top: 12px;
}
.results h4 {
  color: var(--brand);
}
.results h5 {
  color: #9effb0;
  margin-top: 10px;
}
.results li {
  list-style: none;
  margin-bottom: 6px;
  padding: 8px 12px;
  border-radius: 10px;
  background: rgba(0,255,136,0.05);
  border: 1px solid rgba(0,255,136,0.2);
  transition: all 0.2s ease;
}
.results li:hover {
  background: rgba(0,255,136,0.15);
  transform: translateX(3px);
}

.muted {
  color: #888;
  text-align: center;
}

@media(max-width:600px) {
  .home-container { padding: 14px; gap: 18px; }
  .btn { font-size: 0.9rem; }
}
</style>

<!-- ==================== SCRIPT ==================== -->
<script>
(function () {
  const data = {{ boxer_weights_json|safe }};
  const input = document.getElementById("sparBoxerSearch");
  const resultsBox = document.getElementById("searchResults");
  const result = document.getElementById("sparResults");
  const classSelect = document.getElementById("classSelect");
  const classBoxerList = document.getElementById("classBoxerList");
  const searchBox = document.getElementById("searchBox");

  let currentClassId = null; // track selected class

  // ‚úÖ Normalize weight class (remove kg ranges)
  function normalizeWeightClass(label) {
    if (!label) return "";
    return label.split("(")[0].trim().toLowerCase();
  }

  /* ---------------------- SEARCH MODE ---------------------- */
  function showSuggestions(query) {
    if (!query.trim()) {
      resultsBox.style.display = "none";
      return;
    }

    const matches = data.filter(b =>
      b.name.toLowerCase().includes(query.toLowerCase())
    );

    if (!matches.length) {
      resultsBox.innerHTML = `<p style="padding:8px 12px;color:#888;">No boxers found.</p>`;
      resultsBox.style.display = "block";
      return;
    }

    resultsBox.innerHTML = matches
      .map(
        b => `
        <div onclick="selectBoxer(${b.id})"
             style="padding:8px 12px;cursor:pointer;color:var(--text);"
             onmouseover="this.style.background='rgba(0,255,136,0.1)'"
             onmouseout="this.style.background='transparent'">
          <strong style="color:var(--brand);">${b.name}</strong>
          ‚Äî ${b.gender}, ${b.age_band || "‚Äì"}, ${b.weight_class || "?"}
        </div>`
      )
      .join("");

    resultsBox.style.display = "block";
  }

  /* ---------------------- CLASS MODE ---------------------- */
  classSelect.addEventListener("change", e => {
    currentClassId = parseInt(e.target.value, 10) || null;
    resultsBox.style.display = "none";
    result.innerHTML = "";

    if (!currentClassId) {
      searchBox.style.display = "block";
      classBoxerList.style.display = "none";
      result.innerHTML = '<p class="muted">Type a boxer‚Äôs name to begin.</p>';
      return;
    }

    searchBox.style.display = "none";

    // Filter boxers in the selected class
    const classBoxers = data.filter(
      b => Array.isArray(b.class_ids) && b.class_ids.includes(currentClassId)
    );

    if (!classBoxers.length) {
      classBoxerList.innerHTML =
        `<p class="muted">No boxers found for this class.</p>`;
      classBoxerList.style.display = "block";
      return;
    }

    classBoxerList.innerHTML =
      "<ul>" +
      classBoxers
        .map(
          b => `
          <li onclick="selectBoxer(${b.id})"
              style="padding:8px 12px;border-bottom:1px solid var(--border);
                     cursor:pointer;color:var(--text);"
              onmouseover="this.style.background='rgba(0,255,136,0.1)'"
              onmouseout="this.style.background='transparent'">
            <strong style="color:var(--brand);">${b.name}</strong> ‚Äî
            ${b.gender}, ${b.age_band || "‚Äì"}, ${b.weight_class || "?"}
          </li>`
        )
        .join("") +
      "</ul>";

    classBoxerList.style.display = "block";
  });

  /* ---------------------- BOXER SELECTION ---------------------- */
  window.selectBoxer = function (id) {
    const main = data.find(b => b.id === id);
    if (!main) return;

    if (input) input.value = main.name;
    resultsBox.style.display = "none";
    classBoxerList.style.display = "none";

    // ‚ö†Ô∏è Validate data
    if (!main.kg || !main.age || !main.gender) {
      result.innerHTML = `<p class="muted" style="color:#f55;">‚ö†Ô∏è Missing data for ${main.name}.</p>`;
      return;
    }

    const mainClassNorm = normalizeWeightClass(main.weight_class);

    // ‚úÖ Find sparring partners across all gym boxers
    const partners = data
      .filter(b => {
        if (b.id === main.id) return false;
        const sameWeight = normalizeWeightClass(b.weight_class) === mainClassNorm;
        const valid = b.gender && b.age && b.kg;
        return sameWeight && valid;
      })
      .sort((a, b) => {
        const sameBandA = a.age_band === main.age_band;
        const sameBandB = b.age_band === main.age_band;
        if (sameBandA && !sameBandB) return -1;
        if (!sameBandA && sameBandB) return 1;
        const diffA = a.age && main.age ? Math.abs(a.age - main.age) : 99;
        const diffB = b.age && main.age ? Math.abs(b.age - main.age) : 99;
        return diffA - diffB || a.name.localeCompare(b.name);
      });

    // üß† Build the result view
    let html = `
      <div style="background:linear-gradient(145deg,#0f0f0f,#181818);
                  border:1px solid var(--brand);
                  border-radius:12px;padding:12px 16px;
                  box-shadow:0 0 18px rgba(0,255,136,0.3);">
        <h4 style="color:var(--brand);text-shadow:0 0 10px rgba(0,255,136,0.8);margin-bottom:4px;">
          ${main.name}
        </h4>
        <p><em>${main.gender}, ${main.age || "?"} yrs,
        ${main.age_band || "‚Äì"}, ${main.weight_class || "?"}
        (${main.kg ? main.kg.toFixed(1) + " kg" : "‚Äì"})</em></p>
      </div>`;

    if (partners.length) {
      html += `
        <h5 style="margin-top:14px;">ü•ä Suggested partners (${partners.length}):</h5>
        <ul style="list-style:none;padding:0;margin-top:6px;">
          ${partners
            .map(
              p => `
              <li style="background:rgba(15,15,15,0.8);
                         border:1px solid rgba(0,255,136,0.3);
                         border-radius:8px;padding:8px 10px;
                         margin-bottom:6px;transition:all .2s ease;">
                <strong style="color:var(--brand);text-shadow:0 0 6px rgba(0,255,136,0.5);">
                  ${p.name}
                </strong> ‚Äî
                ${p.gender}, ${p.age || "?"} yrs,
                ${p.age_band || "‚Äì"}, ${p.weight_class || "?"}
                (${p.kg ? p.kg.toFixed(1) + " kg" : "‚Äì"})
              </li>`
            )
            .join("")}
        </ul>`;
    } else {
      html += `<p class="muted" style="margin-top:8px;">No suitable partners found in this gym.</p>`;
    }

    result.innerHTML = html;
  };

  if (input) input.addEventListener("input", e => showSuggestions(e.target.value));
})();
</script>

{% endblock %}
