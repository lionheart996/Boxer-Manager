{% extends "base.html" %}
{% block content %}
<h2 class="page-title" style="text-align:center;"> Add Multiple Boxers</h2>
<p class="muted" style="margin-bottom:16px; text-align:center;">
  Add as many as you need. Empty rows are ignored. Use the üóëÔ∏è icon to remove a row.
</p>

<form method="post" id="bulk-form" class="bulk-form">
  {% csrf_token %}
  {{ formset.management_form }}

  <div id="rows" class="rows">
    {% for form in formset %}
      <article class="row-card" data-index="{{ forloop.counter0 }}">
        <div class="row-grid">
          <label>
            <span class="lbl">First name *</span>
            {{ form.first_name }}
            {% if form.first_name.errors %}<span class="err">{{ form.first_name.errors|join:", " }}</span>{% endif %}
          </label>
          <label>
            <span class="lbl">Family name</span>
            {{ form.last_name }}
            {% if form.last_name.errors %}<span class="err">{{ form.last_name.errors|join:", " }}</span>{% endif %}
          </label>
          <label>
            <span class="lbl">Parent (optional)</span>
            {{ form.parent_name }}
            {% if form.parent_name.errors %}<span class="err">{{ form.parent_name.errors|join:", " }}</span>{% endif %}
          </label>
          <label>
            <span class="lbl">Birthday (optional)</span>
            {{ form.date_of_birth }}
            {% if form.date_of_birth.errors %}<span class="err">{{ form.date_of_birth.errors|join:", " }}</span>{% endif %}
          </label>
        </div>

        {{ form.DELETE }} {# hidden but managed via JS #}
        {% if form.non_field_errors %}
          <div class="err">{{ form.non_field_errors|join:", " }}</div>
        {% endif %}

        <button type="button" class="btn btn--danger btn--sm row-remove" aria-label="Remove row">üóëÔ∏è Remove</button>
      </article>
    {% endfor %}
  </div>

  <div class="actions">
    <button type="button" class="btn btn--accent" id="add-row">‚ûï Add another boxer</button>
    <div class="spacer"></div>
    <a class="btn btn--quiet" href="{% url 'home' %}">Cancel</a>
    <button class="btn btn--primary" type="submit">üíæ Save Boxers</button>
  </div>
</form>

{# Template for dynamic row creation #}
<template id="row-template">
  <article class="row-card" data-index="__prefix__">
    <div class="row-grid">
      <label>
        <span class="lbl">First name *</span>
        {{ formset.empty_form.first_name }}
      </label>
      <label>
        <span class="lbl">Family name</span>
        {{ formset.empty_form.last_name }}
      </label>
      <label>
        <span class="lbl">Parent (optional)</span>
        {{ formset.empty_form.parent_name }}
      </label>
      <label>
        <span class="lbl">Birthday (optional)</span>
        {{ formset.empty_form.date_of_birth }}
      </label>
    </div>
    {{ formset.empty_form.DELETE }}
    <button type="button" class="btn btn--danger btn--sm row-remove" aria-label="Remove row">üóëÔ∏è Remove</button>
  </article>
</template>

<style>
.bulk-form { display: grid; gap: 16px; }
.rows { display: grid; gap: 16px; }

/* Card style */
.row-card {
  background: linear-gradient(145deg, #0f0f0f, #181818);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 16px;
  box-shadow: 0 0 12px rgba(0,255,102,0.2);
  transition: transform .2s ease, box-shadow .2s ease;
}
.row-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 0 20px rgba(0,255,102,0.4);
}

.row-grid {
  display: grid;
  gap: 12px;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
}

.lbl { display:block; font-size:13px; color:var(--brand); margin-bottom:4px; font-weight:600; }
.err { display:block; color:#ff4d4d; font-size:12px; margin-top:4px; }

.row-card input[type="text"],
.row-card input[type="date"] {
  width:100%;
  padding:10px 12px;
  border-radius:10px;
  border:1px solid var(--border);
  background:#0f0f0f;
  color:var(--text);
  font-family:monospace;
  transition:border-color .2s ease, box-shadow .2s ease;
}
.row-card input:focus {
  outline:none;
  border-color:var(--brand);
  box-shadow:0 0 8px rgba(0,255,102,0.5);
}

.row-remove {
  margin-top:12px;
  background:#1a1a1a;
  border:1px solid #ff4d4d;
  color:#ff4d4d;
  border-radius:8px;
  padding:6px 10px;
  transition:all .2s ease;
}
.row-remove:hover {
  background:#ff4d4d;
  color:#000;
}

.actions {
  display:flex; align-items:center; gap:10px; margin-top:8px;
}
.actions .spacer { flex:1; }

.btn--accent {
  background:#00ff66;
  color:#000;
  font-weight:700;
  border-radius:10px;
  box-shadow:0 0 10px rgba(0,255,102,0.6);
  transition:all .2s ease;
}
.btn--accent:hover { transform:scale(1.05); box-shadow:0 0 18px rgba(0,255,102,0.9); }
</style>

<script>
(function(){
  const container = document.getElementById('rows');
  const addBtn = document.getElementById('add-row');
  const tmpl = document.getElementById('row-template');
  const totalInput = document.querySelector('[name="{{ formset.prefix }}-TOTAL_FORMS"]') ||
                     document.querySelector('[name="form-TOTAL_FORMS"]');

  function hideDeleteBoxes(scope) {
    (scope || document).querySelectorAll('input[type="checkbox"][name$="-DELETE"]').forEach(cb => {
      cb.style.display = 'none';
    });
  }
  hideDeleteBoxes();

  function wireRemoveButtons(scope) {
    (scope || document).querySelectorAll('.row-remove').forEach(btn => {
      if (btn.dataset.wired) return;
      btn.dataset.wired = "1";
      btn.addEventListener('click', () => {
        const card = btn.closest('.row-card');
        if (!card) return;
        const del = card.querySelector('input[name$="-DELETE"]');
        if (del) { del.checked = true; }
        card.style.display = 'none';
      });
    });
  }
  wireRemoveButtons();

  addBtn?.addEventListener('click', () => {
    const current = parseInt(totalInput.value, 10);
    const html = tmpl.innerHTML.replaceAll('__prefix__', current);
    const wrapper = document.createElement('div');
    wrapper.innerHTML = html.trim();
    const node = wrapper.firstElementChild;
    container.appendChild(node);
    totalInput.value = String(current + 1);
    hideDeleteBoxes(node);
    wireRemoveButtons(node);
    const first = node.querySelector('input, select, textarea');
    if (first) first.focus();
    node.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  });
})();
</script>
{% endblock %}
