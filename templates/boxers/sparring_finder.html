{% extends "base.html" %}
{% block content %}

<main class="sf-container">
  <h1 class="sf-title">üí´ Sparring Partner Finder</h1>
  <p class="sf-subtitle">Select a class, search a boxer, or enter a guest boxer to see ideal sparring partners.</p>

  <!-- ========== NORMAL GYM BOXERS (CLASS + SEARCH) ========== -->
  <section class="sf-card">
    <div class="sf-controls">

      <!-- CLASS SELECT -->
      <div class="sf-group">
        <label for="classSelect" class="sf-label">Choose Class</label>
        <select id="classSelect" class="sf-input">
          <option value="">‚Äî All / search mode ‚Äî</option>
          {% for cls in classes %}
            <option value="{{ cls.id }}">{{ cls.title }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- SEARCH BOX -->
      <div class="sf-group" id="searchBox">
        <label for="sparBoxerSearch" class="sf-label">Search Boxer</label>
        <input type="text" id="sparBoxerSearch" class="sf-input" placeholder="Type a name‚Ä¶" />
        <div id="searchResults" class="sf-dropdown"></div>
      </div>
    </div>

    <div id="classBoxerList" class="sf-results" style="display:none;"></div>

    <div id="sparResults" class="sf-results">
      <p class="sf-muted">Select a class, search a boxer or use the guest boxer form to begin.</p>
    </div>
  </section>

  <!-- ========== GUEST BOXER (NOT IN GYM) ========== -->
  <section class="sf-card" style="margin-top:18px;">
    <h2 class="sf-section-title">üß™ Guest Boxer (Not in Gym)</h2>
    <p class="sf-subtitle">Quickly test sparring matches for an external boxer without adding them to the database.</p>

    <div class="sf-controls">
      <div class="sf-group">
        <label class="sf-label" for="guestName">Name</label>
        <input type="text" id="guestName" class="sf-input" placeholder="e.g. Boxer A" />
      </div>

      <div class="sf-group">
        <label class="sf-label" for="guestAge">Age (years)</label>
        <input type="number" id="guestAge" class="sf-input" placeholder="e.g. 14" min="4" max="80" />
      </div>

      <div class="sf-group">
        <label class="sf-label" for="guestWeight">Weight (kg)</label>
        <input type="number" id="guestWeight" class="sf-input" placeholder="e.g. 56" step="0.1" min="20" max="200" />
      </div>

      <div class="sf-group">
        <label class="sf-label" for="guestGender">Gender (optional)</label>
        <select id="guestGender" class="sf-input">
          <option value="U">Unspecified</option>
          <option value="M">Male</option>
          <option value="F">Female</option>
        </select>
      </div>
    </div>

    <button id="guestFindBtn" class="sf-btn-primary">
      üîç Find Partners for Guest Boxer
    </button>
  </section>

  <!-- OPTIONAL BACK BUTTON -->
  <div class="sf-center">
    <a href="{% url 'home' %}" class="sf-btn-back">‚¨Ö Back to Control Panel</a>
  </div>
</main>

<!-- ====================== STYLES ====================== -->
<style>
:root {
  --brand: #00ff88;
  --bg: #090909;
  --card-bg: linear-gradient(145deg, #0e0e0e, #161616);
  --border: rgba(0,255,136,0.25);
  --text: #eaffea;
}

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Orbitron', sans-serif;
}

/* Layout */
.sf-container {
  max-width: 900px;
  margin: 0 auto;
  padding: 24px;
  display: flex;
  flex-direction: column;
  gap: 22px;
}

.sf-title {
  text-align: center;
  color: var(--brand);
  font-size: 2.1rem;
  text-shadow: 0 0 18px rgba(0,255,136,0.55);
  margin-bottom: -6px;
}
.sf-subtitle {
  text-align: center;
  color: #aaa;
  font-size: 0.95rem;
}

/* Cards */
.sf-card {
  background: var(--card-bg);
  border-radius: 16px;
  padding: 18px;
  border: 1px solid var(--border);
  box-shadow: 0 0 24px rgba(0,255,136,0.16);
  transition: 0.25s;
}
.sf-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 0 34px rgba(0,255,136,0.38);
}

.sf-section-title {
  text-align: center;
  color: var(--brand);
  margin-bottom: 6px;
}

/* Inputs */
.sf-controls {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-top: 6px;
}
.sf-group {
  width: 100%;
}
.sf-label {
  display: block;
  margin-bottom: 3px;
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 0.07em;
  color: #b2ffce;
}
.sf-input {
  width: 100%;
  padding: 10px 14px;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: #111;
  color: var(--text);
  font-size: 0.95rem;
  transition: 0.2s;
}
.sf-input:focus {
  outline: none;
  border-color: var(--brand);
  box-shadow: 0 0 12px rgba(0,255,136,0.6);
}

/* Dropdown */
.sf-dropdown {
  display: none;
  background: #101010;
  border-radius: 12px;
  border: 1px solid var(--border);
  margin-top: 6px;
  max-height: 220px;
  overflow-y: auto;
  box-shadow: 0 0 22px rgba(0,255,136,0.2);
}
.sf-dropdown-item {
  padding: 8px 12px;
  cursor: pointer;
}
.sf-dropdown-item:hover {
  background: rgba(0,255,136,0.15);
}

/* Results */
.sf-results {
  margin-top: 18px;
  border-top: 1px solid var(--border);
  padding-top: 12px;
}
.sf-muted {
  color: #777;
  text-align: center;
}

/* Main boxer card */
.sf-main-boxer {
  background: rgba(0,255,136,0.07);
  border-radius: 14px;
  padding: 10px 14px;
  border: 1px solid var(--brand);
  box-shadow: 0 0 18px rgba(0,255,136,0.35);
}
.sf-main-boxer h3 {
  margin-bottom: 4px;
  color: var(--brand);
  text-shadow: 0 0 6px rgba(0,255,136,0.4);
}

/* Partner list */
.sf-partner-item {
  list-style: none;
  padding: 8px 12px;
  margin-bottom: 6px;
  border-radius: 10px;
  border: 1px solid rgba(0,255,136,0.25);
  background: rgba(0,255,136,0.04);
  transition: 0.2s;
}
.sf-partner-item:hover {
  background: rgba(0,255,136,0.14);
  transform: translateX(3px);
}

/* Buttons */
.sf-btn-primary {
  margin-top: 12px;
  width: 100%;
  padding: 9px 18px;
  border-radius: 10px;
  border: 1px solid var(--brand);
  background: transparent;
  color: var(--brand);
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 0 16px rgba(0,255,136,0.3);
  transition: 0.25s;
}
.sf-btn-primary:hover {
  background: var(--brand);
  color: #000;
  box-shadow: 0 0 28px rgba(0,255,136,0.9);
}

.sf-center {
  text-align: center;
}
.sf-btn-back {
  display: inline-block;
  margin-top: 4px;
  padding: 8px 14px;
  border-radius: 10px;
  border: 1px solid var(--brand);
  color: var(--brand);
  text-decoration: none;
  transition: 0.2s;
}
.sf-btn-back:hover {
  background: var(--brand);
  color: #000;
}

/* Mobile */
@media(max-width: 620px) {
  .sf-container { padding: 14px; }
  .sf-title { font-size: 1.8rem; }
}
</style>

<!-- ====================== SCRIPT ====================== -->
<script>
(function () {
  const data = JSON.parse('{{ boxer_data_json|escapejs }}');

  const input          = document.getElementById("sparBoxerSearch");
  const resultsBox     = document.getElementById("searchResults");
  const sparResults    = document.getElementById("sparResults");
  const classSelect    = document.getElementById("classSelect");
  const classBoxerList = document.getElementById("classBoxerList");
  const searchBox      = document.getElementById("searchBox");

  const guestName   = document.getElementById("guestName");
  const guestAge    = document.getElementById("guestAge");
  const guestWeight = document.getElementById("guestWeight");
  const guestGender = document.getElementById("guestGender");
  const guestBtn    = document.getElementById("guestFindBtn");

  function normalize(label) {
    if (!label) return "";
    return label.split("(")[0].trim().toLowerCase();
  }

  /* ------- Helper: render matches (used by both real & guest boxers) ------- */
  function findPartners(main) {
    let partners;

    // guest boxer: infer by kg/age instead of weight_class string
    if (main.id === "guest") {
      partners = data.filter(b => b.kg && b.age && b.gender && b.weight_class);

      // Optional: limit to +/- 5kg, but still sort by closeness
      partners = partners
        .filter(b => Math.abs(b.kg - main.kg) <= 7)  // soft window
        .sort((a, b) => {
          const bandA = a.age_band === main.age_band;
          const bandB = b.age_band === main.age_band;
          if (bandA && !bandB) return -1;
          if (!bandA && bandB) return 1;

          const diffA = Math.abs(a.kg - main.kg);
          const diffB = Math.abs(b.kg - main.kg);
          if (diffA !== diffB) return diffA - diffB;

          const ageDiffA = Math.abs(a.age - main.age);
          const ageDiffB = Math.abs(b.age - main.age);
          return ageDiffA - ageDiffB || a.name.localeCompare(b.name);
        });

      return partners;
    }

    // normal boxer: match by same weight class (your original logic)
    const mainNorm = normalize(main.weight_class);

    partners = data.filter(b => {
      if (b.id === main.id) return false;
      const sameW = normalize(b.weight_class) === mainNorm;
      return sameW && b.gender && b.age && b.kg;
    });

    partners = partners.sort((a, b) => {
      const bandA = a.age_band === main.age_band;
      const bandB = b.age_band === main.age_band;
      if (bandA && !bandB) return -1;
      if (!bandA && bandB) return 1;

      const diffA = Math.abs(a.age - main.age);
      const diffB = Math.abs(b.age - main.age);

      return diffA - diffB || a.name.localeCompare(b.name);
    });

    return partners;
  }

  function renderMatches(main) {
    const partners = findPartners(main);

    let html = `
      <div class="sf-main-boxer">
        <h3>${main.name}${main.id === "guest" ? " (Guest Boxer)" : ""}</h3>
        <p><em>${main.gender}, ${main.age || "?"} yrs,
        ${main.age_band || "‚Äì"},
        ${main.weight_class || "?"} (${main.kg ? main.kg + " kg" : "‚Äì"})</em></p>
      </div>
    `;

    if (!partners.length) {
      html += `<p class="sf-muted" style="margin-top:10px;">No suitable partners found.</p>`;
    } else {
      html += `<h4 style="margin-top:14px;color:var(--brand);">ü•ä Suggested partners (${partners.length}):</h4>`;
      html += `<ul style="margin-top:6px;padding:0;">`;
      html += partners.map(p => `
        <li class="sf-partner-item">
          <strong style="color:var(--brand);">${p.name}</strong> ‚Äî
          ${p.gender}, ${p.age || "?"} yrs,
          ${p.age_band || "‚Äì"},
          ${p.weight_class || "?"} (${p.kg ? p.kg + " kg" : "‚Äì"})
        </li>
      `).join("");
      html += `</ul>`;
    }

    sparResults.innerHTML = html;
  }

  /* -------------------- SEARCH MODE -------------------- */
  function showSuggestions(query) {
    if (!query.trim()) {
      resultsBox.style.display = "none";
      resultsBox.innerHTML = "";
      return;
    }

    const matches = data.filter(b =>
      (b.name || "").toLowerCase().includes(query.toLowerCase())
    );

    if (!matches.length) {
      resultsBox.innerHTML = `<div class="sf-dropdown-item sf-muted">No boxers found</div>`;
      resultsBox.style.display = "block";
      return;
    }

    resultsBox.innerHTML = matches.map(b => `
      <div class="sf-dropdown-item" onclick="selectBoxer(${b.id})">
        <strong style="color:var(--brand);">${b.name}</strong> ‚Äî
        ${b.gender}, ${b.age_band || "‚Äì"}, ${b.weight_class || "?"}
      </div>
    `).join("");

    resultsBox.style.display = "block";
  }

  if (input) {
    input.addEventListener("input", e => showSuggestions(e.target.value));
  }

  /* -------------------- CLASS MODE -------------------- */
  if (classSelect) {
    classSelect.addEventListener("change", e => {
      const classId = parseInt(e.target.value) || null;
      sparResults.innerHTML = "";
      resultsBox.style.display = "none";

      if (!classId) {
        searchBox.style.display = "block";
        classBoxerList.style.display = "none";
        sparResults.innerHTML = '<p class="sf-muted">Search for a boxer to begin.</p>';
        return;
      }

      searchBox.style.display = "none";

      const classBoxers = data.filter(b =>
        Array.isArray(b.class_ids) && b.class_ids.includes(classId)
      );

      if (!classBoxers.length) {
        classBoxerList.innerHTML = `<p class="sf-muted">No boxers in this class.</p>`;
        classBoxerList.style.display = "block";
        return;
      }

      classBoxerList.innerHTML = `
        <ul>
          ${classBoxers.map(b => `
            <li class="sf-partner-item" onclick="selectBoxer(${b.id})">
              <strong style="color:var(--brand);">${b.name}</strong> ‚Äî
              ${b.gender}, ${b.age_band || "‚Äì"}, ${b.weight_class || "?"}
            </li>
          `).join("")}
        </ul>
      `;
      classBoxerList.style.display = "block";
    });
  }

  /* -------------------- REAL BOXER SELECT -------------------- */
  window.selectBoxer = function (id) {
    const main = data.find(b => b.id === id);
    if (!main) return;

    if (input) input.value = main.name;
    if (resultsBox) resultsBox.style.display = "none";
    if (classBoxerList) classBoxerList.style.display = "none";

    if (!main.gender || !main.age || !main.kg) {
      sparResults.innerHTML =
        `<p class="sf-muted" style="color:#f66;">‚ö† Missing data for ${main.name}.</p>`;
      return;
    }

    renderMatches(main);
  };

  /* -------------------- GUEST BOXER BUTTON -------------------- */
  if (guestBtn) {
    guestBtn.addEventListener("click", () => {
      const name = (guestName.value || "").trim();
      const age  = parseInt(guestAge.value);
      const kg   = parseFloat(guestWeight.value);
      const gender = guestGender.value || "U";

      if (!name || !age || !kg) {
        sparResults.innerHTML =
          `<p class="sf-muted" style="color:#f66;">Please fill in name, age and weight for the guest boxer.</p>`;
        return;
      }

      // simple age band, to mirror backend-ish behaviour
      function ageBand(a) {
        if (a <= 11) return "Aspirant";
        if (12 <= a <= 14) return "SBG";
        if (15 <= a <= 17) return "Junior";
        if (18 <= a <= 19) return "Youth";
        if (a >= 19) return "Elite";

      }

      const guest = {
        id: "guest",
        name,
        age,
        kg,
        gender,
        age_band: ageBand(age),
        // we don't know exact official weight class; leave null,
        // partner-finding for guest uses kg based logic
        weight_class: null,
        class_ids: []
      };

      // make sure search mode UI doesn't interfere
      if (resultsBox) resultsBox.style.display = "none";
      if (classBoxerList) classBoxerList.style.display = "none";
      if (input) input.value = "";

      renderMatches(guest);
    });
  }
})();
</script>

{% endblock %}
