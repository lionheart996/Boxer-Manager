{% extends "base.html" %}
{% block content %}

<main class="sf-container">
  <h1 class="sf-title">üí´ Sparring Partner Finder</h1>
  <p class="sf-subtitle">Search or select a boxer ‚Äî or enter a guest boxer to test matchups.</p>

  <!-- ====================== CLASS / SEARCH BOX ====================== -->
  <section class="sf-card">
    <div class="sf-controls">

      <!-- CLASS SELECT -->
      <div class="sf-group">
        <label for="classSelect" class="sf-label">Choose Class</label>
        <select id="classSelect" class="sf-input">
          <option value="">‚Äî All / search mode ‚Äî</option>
          {% for cls in classes %}
            <option value="{{ cls.id }}">{{ cls.title }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- SEARCH BOX -->
      <div class="sf-group" id="searchBox">
        <label for="sparBoxerSearch" class="sf-label">Search Boxer</label>
        <input type="text" id="sparBoxerSearch" class="sf-input" placeholder="Type a name‚Ä¶" />
        <div id="searchResults" class="sf-dropdown"></div>
      </div>
    </div>

    <!-- CLASS RESULTS -->
    <div id="classBoxerList" class="sf-results" style="display:none;"></div>

    <!-- MAIN RESULTS -->
    <div id="sparResults" class="sf-results">
      <p class="sf-muted">Select a class, search a boxer, or use guest boxer form below.</p>
    </div>
  </section>

  <!-- ====================== GUEST BOXER FORM ====================== -->
  <section class="sf-card" style="margin-top:18px;">
    <h2 class="sf-section-title">üß™ Guest Boxer (Not in Gym)</h2>
    <p class="sf-subtitle">Enter a boxer that is not in the gym roster.</p>

    <div class="sf-controls">

      <div class="sf-group">
        <label class="sf-label" for="guestName">Name</label>
        <input type="text" id="guestName" class="sf-input" placeholder="e.g. Boxer A">
      </div>

      <div class="sf-group">
        <label class="sf-label" for="guestAge">Age</label>
        <input type="number" id="guestAge" class="sf-input" placeholder="e.g. 14" min="4" max="80">
      </div>

      <div class="sf-group">
        <label class="sf-label" for="guestWeight">Weight (kg)</label>
        <input type="number" id="guestWeight" class="sf-input" placeholder="e.g. 56" step="0.1" min="20" max="200">
      </div>

      <div class="sf-group">
        <label class="sf-label" for="guestGender">Gender</label>
        <select id="guestGender" class="sf-input">
          <option value="U">Unspecified</option>
          <option value="M">Male</option>
          <option value="F">Female</option>
        </select>
      </div>
    </div>

    <button id="guestFindBtn" class="sf-btn-primary">
      üîç Find Partners for Guest Boxer
    </button>
  </section>

  <!-- BACK BUTTON -->
  <div class="sf-center" style="margin-top:16px;">
    <a href="{% url 'home' %}" class="sf-btn-back">‚¨Ö Back to Control Panel</a>
  </div>
</main>

<!-- ====================== STYLES ====================== -->
<style>
:root {
  --brand: #00ff88;
  --bg: #090909;
  --card-bg: linear-gradient(145deg, #0e0e0e, #161616);
  --border: rgba(0,255,136,0.25);
  --text: #eaffea;
}

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Orbitron', sans-serif;
}

.sf-container {
  max-width: 900px;
  margin: auto;
  padding: 24px;
  display: flex;
  flex-direction: column;
  gap: 22px;
}

.sf-title {
  text-align: center;
  color: var(--brand);
  font-size: 2.1rem;
  text-shadow: 0 0 18px rgba(0,255,136,0.55);
}

.sf-subtitle {
  text-align: center;
  color: #aaa;
  font-size: 0.95rem;
}

.sf-card {
  background: var(--card-bg);
  border-radius: 16px;
  padding: 18px;
  border: 1px solid var(--border);
  box-shadow: 0 0 24px rgba(0,255,136,0.16);
}

.sf-controls {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-top: 6px;
}

.sf-group { width: 100%; }

.sf-label {
  display: block;
  margin-bottom: 3px;
  font-size: 0.8rem;
  text-transform: uppercase;
  color: #b2ffce;
}

.sf-input {
  width: 100%;
  padding: 10px 14px;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: #111;
  color: var(--text);
  font-size: 0.95rem;
}

.sf-dropdown {
  display: none;
  background: #101010;
  border-radius: 12px;
  border: 1px solid var(--border);
  margin-top: 6px;
  max-height: 220px;
  overflow-y: auto;
}

.sf-results {
  margin-top: 18px;
  border-top: 1px solid var(--border);
  padding-top: 12px;
}

.sf-muted {
  color: #777;
  text-align: center;
}

.sf-main-boxer {
  background: rgba(0,255,136,0.07);
  border-radius: 14px;
  padding: 10px 14px;
  border: 1px solid var(--brand);
}

.sf-partner-item {
  list-style: none;
  padding: 10px 12px;
  margin-bottom: 6px;
  border-radius: 10px;
  border: 1px solid rgba(0,255,136,0.25);
  background: rgba(0,255,136,0.04);
}

.sf-btn-primary {
  margin-top: 12px;
  width: 100%;
  padding: 10px;
  border-radius: 10px;
  border: 1px solid var(--brand);
  color: var(--brand);
  background: transparent;
  cursor: pointer;
}

.sf-btn-back {
  padding: 8px 14px;
  border-radius: 10px;
  border: 1px solid var(--brand);
  color: var(--brand);
  text-decoration: none;
}
</style>

<!-- ====================== SCRIPT ====================== -->
<script>
(function () {

  /* ==========================================================
     FULL IBA WEIGHT CLASS TABLE IN JAVASCRIPT (NO ERRORS)
     ========================================================== */
  const IBA = {
    "M_JUNIOR": [
      ["Pinweight", 44, 46],
      ["Light Flyweight", 46, 48],
      ["Flyweight", 48, 50],
      ["Light Bantamweight", 50, 52],
      ["Bantamweight", 52, 54],
      ["Featherweight", 54, 57],
      ["Lightweight", 57, 60],
      ["Light Welterweight", 60, 63],
      ["Welterweight", 63, 66],
      ["Light Middleweight", 66, 70],
      ["Middleweight", 70, 75],
      ["Light Heavyweight", 75, 80],
      ["Heavyweight", 80, 999],
    ],
    "M_YOUTH": [
      ["Minimumweight", 46, 48],
      ["Flyweight", 48, 51],
      ["Bantamweight", 51, 54],
      ["Featherweight", 54, 57],
      ["Lightweight", 57, 60],
      ["Light Welterweight", 60, 63.5],
      ["Welterweight", 63.5, 67],
      ["Light Middleweight", 67, 71],
      ["Middleweight", 71, 75],
      ["Light Heavyweight", 75, 80],
      ["Cruiserweight", 80, 86],
      ["Heavyweight", 86, 92],
      ["Super Heavyweight", 92, 999],
    ],
    "M_ELITE": [
      ["Minimumweight", 46, 48],
      ["Flyweight", 48, 51],
      ["Bantamweight", 51, 54],
      ["Featherweight", 54, 57],
      ["Lightweight", 57, 60],
      ["Light Welterweight", 60, 63.5],
      ["Welterweight", 63.5, 67],
      ["Light Middleweight", 67, 71],
      ["Middleweight", 71, 75],
      ["Light Heavyweight", 75, 80],
      ["Cruiserweight", 80, 86],
      ["Heavyweight", 86, 92],
      ["Super Heavyweight", 92, 999],
    ],

    "F_JUNIOR": [
      ["Pinweight", 44, 46],
      ["Light Flyweight", 46, 48],
      ["Flyweight", 48, 50],
      ["Light Bantamweight", 50, 52],
      ["Bantamweight", 52, 54],
      ["Featherweight", 54, 57],
      ["Lightweight", 57, 60],
      ["Light Welterweight", 60, 63],
      ["Welterweight", 63, 66],
      ["Light Middleweight", 66, 70],
      ["Middleweight", 70, 75],
      ["Light Heavyweight", 75, 81],
      ["Heavyweight", 81, 999],
    ],

    "F_YOUTH": [
      ["Minimumweight", 45, 48],
      ["Flyweight", 48, 50],
      ["Bantamweight", 50, 52],
      ["Featherweight", 52, 54],
      ["Lightweight", 54, 57],
      ["Light Welterweight", 57, 60],
      ["Welterweight", 60, 63],
      ["Light Middleweight", 63, 66],
      ["Middleweight", 66, 70],
      ["Light Heavyweight", 70, 75],
      ["Heavyweight", 75, 81],
      ["Super Heavyweight", 81, 999],
    ],

    "F_ELITE": [
      ["Minimumweight", 45, 48],
      ["Flyweight", 48, 50],
      ["Bantamweight", 50, 52],
      ["Featherweight", 52, 54],
      ["Lightweight", 54, 57],
      ["Light Welterweight", 57, 60],
      ["Welterweight", 60, 63],
      ["Light Middleweight", 63, 66],
      ["Middleweight", 66, 70],
      ["Light Heavyweight", 70, 75],
      ["Heavyweight", 75, 81],
      ["Super Heavyweight", 81, 999],
    ]
  };

  /* ==========================================================
     UTILITY FUNCTIONS
     ========================================================== */

  function ageBand(age) {
    if (age == null) return null;
    if (age <= 14) return "JUNIOR";
    if (age <= 16) return "JUNIOR";
    if (age <= 18) return "YOUTH";
    return "ELITE";
  }

  function getIBAClass(kg, gender, age) {
    const band = ageBand(age) || "JUNIOR";
    const key = `${gender}_${band}`;
    const classes = IBA[key];
    if (!classes) return null;

    for (const c of classes) {
      if (kg >= c[1] && kg <= c[2]) {
        if (c[2] >= 999) {
          return `${c[0]} (${c[1]}kg+)`;
        }
        return `${c[0]} (${c[1]}‚Äì${c[2]}kg)`;
      }
    }
    return null;
  }

  /* ==========================================================
     LOAD GYM DATA
     ========================================================== */
  const data = JSON.parse('{{ boxer_data_json|escapejs }}');

  const input = document.getElementById("sparBoxerSearch");
  const resultsBox = document.getElementById("searchResults");
  const sparResults = document.getElementById("sparResults");
  const classSelect = document.getElementById("classSelect");
  const classBoxerList = document.getElementById("classBoxerList");
  const searchBox = document.getElementById("searchBox");

  const guestName   = document.getElementById("guestName");
  const guestAge    = document.getElementById("guestAge");
  const guestWeight = document.getElementById("guestWeight");
  const guestGender = document.getElementById("guestGender");
  const guestBtn    = document.getElementById("guestFindBtn");

  /* ==========================================================
     PARTNER FINDER (GYM + GUEST)
     ========================================================== */

  function renderMatches(main, partners) {

    let html = `
      <div class="sf-main-boxer">
        <h3>${main.name}${main.id === "guest" ? " (Guest Boxer)" : ""}</h3>
        <p><em>
          ${main.gender}, ${main.age} yrs,
          ${main.age_band},
          ${main.weight_class || "?"}
          (${main.kg} kg)
        </em></p>
      </div>
    `;

    if (!partners.length) {
      html += `<p class="sf-muted" style="margin-top:10px;">No suitable partners found.</p>`;
    } else {
      html += `<h4 style="margin-top:16px;color:var(--brand);">ü•ä Suggested partners (${partners.length}):</h4>`;
      html += `<ul style="margin-top:6px;padding:0;">`;
      html += partners.map(p => `
        <li class="sf-partner-item">
          <strong style="color:var(--brand);">${p.name}</strong>
          ‚Äî ${p.gender}, ${p.age} yrs,
          ${p.age_band}, ${p.weight_class} (${p.kg} kg)
        </li>
      `).join("");
      html += `</ul>`;
    }

    sparResults.innerHTML = html;
  }

  function normalize(label) {
    if (!label) return "";
    return label.split("(")[0].trim().toLowerCase();
  }

  /* Gym boxer */
  window.selectBoxer = function (id) {
    const main = data.find(b => b.id === id);
    if (!main) return;

    const mainNorm = normalize(main.weight_class);

    const partners = data
      .filter(b => b.id !== main.id && normalize(b.weight_class) === mainNorm)
      .sort((a, b) => Math.abs(a.age - main.age) - Math.abs(b.age - main.age));

    renderMatches(main, partners);
  }

  /* Guest boxer */
  guestBtn.addEventListener("click", () => {
    const name = guestName.value.trim();
    const age = parseInt(guestAge.value);
    const kg = parseFloat(guestWeight.value);
    const gender = guestGender.value || "U";

    if (!name || !age || !kg) {
      sparResults.innerHTML = `<p class="sf-muted" style="color:#f66;">Fill name, age, and weight.</p>`;
      return;
    }

    const band = ageBand(age);
    const wc = getIBAClass(kg, gender, age);

    const guest = {
      id: "guest",
      name,
      age,
      kg,
      gender,
      age_band: band,
      weight_class: wc,
      class_ids: []
    };

    const partners = data
      .filter(b => {
        return b.weight_class && wc &&
               normalize(b.weight_class) === normalize(wc);
      })
      .sort((a, b) => Math.abs(a.age - guest.age) - Math.abs(b.age - guest.age));

    renderMatches(guest, partners);
  });

})();
</script>

{% endblock %}
